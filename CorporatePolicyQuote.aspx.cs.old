using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using EPolicy.TaskControl;
using Baldrich.DBRequest;
using EPolicy.XmlCooker;
using System.Xml;
using EPolicy2.Reports;
using EPolicy.LookupTables;
using EPolicy;

namespace EPolicy
{
    public partial class CorporatePolicyQuote : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            this.litPopUp.Visible = false;

            Control Banner = new Control();
            Banner = LoadControl(@"TopBanner.ascx");
            this.Placeholder1.Controls.Add(Banner);

            //Setup Left-side Banner			
            Control LeftMenu = new Control();
            LeftMenu = LoadControl(@"LeftMenu.ascx");
            phTopBanner1.Controls.Add(LeftMenu);

            if (Session["AutoPostBack"] == null)
            {
                if (!IsPostBack)
                {
                    if (Session["TaskControl"] != null)
                    {
                        EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

                        //ddlCiudad.Attributes.Add("onchange", "getExpDt()");
                        TxtTerm.Attributes.Add("onblur", "getExpDt()");
                        txtEffDt.Attributes.Add("onblur", "getExpDt();SetFieldDate()");
                        //TxtZip.Attributes.Add("onblur", "SetCiudad()");
                        //ddlCiudad.Attributes.Add("onchange", "SetZipCode()");

                        LookupTables.MasterPolicy master = new LookupTables.MasterPolicy();
                        DataTable dtCorporation = master.GetMasterPolicyByIsGroup(false);
                        DataTable dtPRMedicalLimit = LookupTables.LookupTables.GetTable("PRMedicalLimit");
                        DataTable dtPRPrimaryLimit = LookupTables.LookupTables.GetTable("PRPrimaryLimit");
                        DataTable dtCiudad = LookupTables.LookupTables.GetTable("Ciudad");
                        DataTable dtLocation = LookupTables.LookupTables.GetTable("Location");
                        DataTable dtAgency = LookupTables.LookupTables.GetTable("Agency");
                        DataTable dtAgent = LookupTables.LookupTables.GetTable("Agent");
                        DataTable dtInsuranceCompany = LookupTables.LookupTables.GetTable("InsuranceCompany");
                        DataTable dtFinancial = LookupTables.LookupTables.GetTable("Financial");
                        DataTable dtPRMEDICRATE2 = EPolicy.LookupTables.LookupTables.GetTable("PRMEDICSpecialty");

                        //Corporation
                        ddlCorparation.DataSource = dtCorporation;
                        ddlCorparation.DataTextField = "MasterPolicyDesc";
                        ddlCorparation.DataValueField = "MasterPolicyID";
                        ddlCorparation.DataBind();
                        ddlCorparation.SelectedIndex = -1;
                        ddlCorparation.Items.Insert(0, "");

                        //Location
                        ddlOriginatedAt.DataSource = dtLocation;
                        ddlOriginatedAt.DataTextField = "locationDesc";
                        ddlOriginatedAt.DataValueField = "locationID";
                        ddlOriginatedAt.DataBind();
                        ddlOriginatedAt.SelectedIndex = -1;
                        ddlOriginatedAt.Items.Insert(0, "");

                        //Agency
                        ddlAgency.DataSource = dtAgency;
                        ddlAgency.DataTextField = "AgencyDesc";
                        ddlAgency.DataValueField = "AgencyID";
                        ddlAgency.DataBind();
                        ddlAgency.SelectedIndex = -1;
                        ddlAgency.Items.Insert(0, "");

                        //Agent
                        ddlAgent.DataSource = dtAgent;
                        ddlAgent.DataTextField = "AgentDesc";
                        ddlAgent.DataValueField = "AgentID";
                        ddlAgent.DataBind();
                        ddlAgent.SelectedIndex = -1;
                        ddlAgent.Items.Insert(0, "");

                        //InsuranceCompany
                        ddlInsuranceCompany.DataSource = dtInsuranceCompany;
                        ddlInsuranceCompany.DataTextField = "InsuranceCompanyDesc";
                        ddlInsuranceCompany.DataValueField = "InsuranceCompanyID";
                        ddlInsuranceCompany.DataBind();
                        ddlInsuranceCompany.SelectedIndex = -1;
                        ddlInsuranceCompany.Items.Insert(0, "");

                        ////Ciudad
                        //ddlCiudad.DataSource = dtCiudad;
                        //ddlCiudad.DataTextField = "Ciudad";
                        //ddlCiudad.DataValueField = "ZipCode";
                        //ddlCiudad.DataBind();
                        //ddlCiudad.SelectedIndex = -1;
                        //ddlCiudad.Items.Insert(0, "");

                        //Financial
                        ddlFinancial.DataSource = dtFinancial;
                        ddlFinancial.DataTextField = "FinancialDesc";
                        ddlFinancial.DataValueField = "FinancialID";
                        ddlFinancial.DataBind();
                        ddlFinancial.SelectedIndex = -1;
                        ddlFinancial.Items.Insert(0, "");

                        //Other Specialty
                        ddlOtherSpecialty.Items.Clear();
                        ddlOtherSpecialty.DataSource = dtPRMEDICRATE2;
                        ddlOtherSpecialty.DataTextField = "PRMEDICSpecialtyDesc";
                        ddlOtherSpecialty.DataValueField = "PRMEDICSpecialtyID";
                        ddlOtherSpecialty.DataBind();
                        ddlOtherSpecialty.SelectedIndex = -1;
                        ddlOtherSpecialty.Items.Insert(0, "");

                        //PRPrimaryLimit
                        ddlPrimaryLimits1.DataSource = dtPRPrimaryLimit;
                        ddlPrimaryLimits1.DataTextField = "PRMedicalLimitDesc";
                        ddlPrimaryLimits1.DataValueField = "PRMedicalLimitID";
                        ddlPrimaryLimits1.DataBind();
                        ddlPrimaryLimits1.SelectedIndex = -1;
                        ddlPrimaryLimits1.Items.Insert(0, "");

                        //PRMedicalLimit
                        ddlLimits.DataSource = dtPRMedicalLimit;
                        ddlLimits.DataTextField = "PRMedicalLimitDesc";
                        ddlLimits.DataValueField = "PRMedicalLimitID";
                        ddlLimits.DataBind();
                        ddlLimits.SelectedIndex = -1;
                        ddlLimits.Items.Insert(0, "");

                        //PRMedicalLimit
                        if (taskControl.PolicyType.Trim() == "CE")
                            ddlPrMedicalLimits.DataSource = dtPRMedicalLimit;
                        else
                            ddlPrMedicalLimits.DataSource = dtPRPrimaryLimit;

                        ddlPrMedicalLimits.DataTextField = "PRMedicalLimitDesc";
                        ddlPrMedicalLimits.DataValueField = "PRMedicalLimitID";
                        ddlPrMedicalLimits.DataBind();
                        ddlPrMedicalLimits.SelectedIndex = -1;
                        ddlPrMedicalLimits.Items.Insert(0, "");

                        switch (taskControl.Mode)
                        {
                            case 1: //ADD
                                EnableControls();
                                FillTextControl();
                                if (!taskControl.IsPolicy)
                                    SetDefaulValue();
                                break;

                            case 2: //UPDATE
                                FillTextControl();
                                EnableControls();
                                break;

                            default:
                                FillTextControl();
                                DisableControls();
                                break;
                        }
                    }
                }
                else
                {
                    if (Session["TaskControl"] != null)
                    {
                        EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
                        if (taskControl.Mode == 4)
                        {
                            DisableControls();
                        }
                    }
                }
            }
            else
            {
                FillTextControl();
                EnableControls();
                Session.Remove("AutoPostBack");
            }
        }

        private void SetDefaulValue()
        {
            txtDiscountP.Text = "25%";
            txtDiscount.Text = "15%";
            //Primary
            txtRateTN1.Text = "25%";
            txtRateTN2.Text = "50%";
            txtRateTN3.Text = "75%";
            txtRateTN4.Text = "20%";
            txtRateTN5.Text = "10%";
            txtRateTN6.Text = "25%";

            //Excess
            txtERateTN1.Text = "15%";
            txtERateTN2.Text = "50%";
            txtERateTN3.Text = "50%";
            txtERateTN4.Text = "10%";
            txtERateTN5.Text = "2.5%";
            txtERateTN6.Text = "15%";
        }

        private void EnableControls()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            btnEdit.Visible = false;
            BtnExit.Visible = false;
            btnPrint.Visible = false;
            btnPrintCertificate.Visible = false;
            btnAddNew.Visible = false;
            BtnSave.Visible = true;
            btnCalcCharge.Visible = true;
            cmdCancel.Visible = true;
            Button2.Visible = true;
            Button3.Visible = true;
            btnCancellation.Visible = false;
            btnDelete.Visible = false;

            if (taskControl.IsPolicy)
            {
                btnConvert.Visible = false;
                btnConvertPrimary.Visible = false;
                btnRenew.Visible = false;
                txtCorporation.Visible = false;
                txtCustomerName2.Visible = false;
                pnlPolicy.Visible = true;
                ddlSelectedAgent.Visible = false;
                Label8.Visible = false;
                Label18.Visible = false;
                btnPayments.Visible = true;

                VerifyAssignPolicyFields();

                if (taskControl.PolicyType.Trim() == "CP")
                {
                    pnlPrimary.Visible = true;
                    pnlExcess.Visible = false;
                    Label40.Visible = true;
                    Label16.Visible = false;
                    Label17.Visible = true;
                    Label15.Visible = false;
                    Label7.Visible = true;
                    Label39.Visible = false;

                    txtDiscountP.Visible = true;
                    txtDiscount.Visible = false;
                    txtTotalPrimaryPremium.Visible = true;
                    txtTotalExcessPremium.Visible = false;
                    Label13.Visible = true;
                    Label9.Visible = false;
                    txtTotalPrimaryCorporate.Visible = true;
                    txtTotalExcessCorporate.Visible = false;
                }
                else
                {
                    pnlPrimary.Visible = false;
                    pnlExcess.Visible = true;
                    Label40.Visible = false;
                    Label16.Visible = true;
                    Label17.Visible = false;
                    Label15.Visible = true;
                    Label7.Visible = false;
                    Label39.Visible = true;

                    txtDiscountP.Visible = false;
                    txtDiscount.Visible = true;
                    txtTotalPrimaryPremium.Visible = false;
                    txtTotalExcessPremium.Visible = true;
                    Label13.Visible = false;
                    Label9.Visible = true;
                    txtTotalPrimaryCorporate.Visible = false;
                    txtTotalExcessCorporate.Visible = true;
                }
            }
            else
            {
                btnConvert.Visible = false;
                btnConvertPrimary.Visible = false;
                btnRenew.Visible = false;
                btnPayments.Visible = false;
                txtCorporation.Visible = true;
                txtCustomerName2.Visible = true;
                pnlPolicy.Visible = false;
                pnlPrimary.Visible = true;
                pnlExcess.Visible = true;
                Label40.Visible = true;
                Label16.Visible = true;
                Label17.Visible = true;
                Label15.Visible = true;
                Label7.Visible = true;
                Label39.Visible = true;
                Label8.Visible = true;
                Label18.Visible = true;
                txtDiscountP.Visible = true;
                txtDiscount.Visible = true;
                txtTotalPrimaryPremium.Visible = true;
                txtTotalExcessPremium.Visible = true;
                Label13.Visible = true;
                Label9.Visible = true;
                txtTotalPrimaryCorporate.Visible = true;
                txtTotalExcessCorporate.Visible = true;
            }

            Login.Login cp = HttpContext.Current.User as Login.Login;
            if (cp.IsInRole("ADMINISTRATOR"))
                TxtCustomerNo.Enabled = true;
            else
                TxtCustomerNo.Enabled = false;

            TxtFirstName.Enabled = true;
            TxtInitial.Enabled = true;
            txtLastname1.Enabled = true;
            txtLastname2.Enabled = true;
            TxtAddrs1.Enabled = true;
            TxtAddrs2.Enabled = true;
            TxtCity.Enabled = true;
            TxtState.Enabled = true;
            TxtZip.Enabled = true;
            txtHomePhone.Enabled = true;
            txtWorkPhone.Enabled = true;
            TxtCellular.Enabled = true;
            txtEmail.Enabled = true;
            txtLicense.Enabled = true;
            TxtPolicyNo.Enabled = true;
            TxtCertificate.Enabled = true;
            TxtPolicyType.Enabled = true;
            TxtSufijo.Enabled = true;
            TxtAnniversary.Enabled = true;
            TxtTerm.Enabled = true;
            ddlCorparation.Enabled = true;
            ddlSelectedAgent.Enabled = true;
            TxtRetroactiveDate.Enabled = true;
            txtEffDt.Enabled = true;
            txtExpDt.Enabled = true;
            txtEntryDate.Enabled = true;
            TxtCharge.Enabled = true;
            TxtTotalPremium.Enabled = true;
            TxtComments.Enabled = true;

            ddlOriginatedAt.Enabled = true;
            ddlInsuranceCompany.Enabled = true;
            ddlAgency.Enabled = true;
            ddlAgent.Enabled = true;
            ddlFinancial.Enabled = true;
            ddlOtherSpecialty.Enabled = true;
            ddlPolicyClass.Enabled = false;
            chkPaymentGA.Enabled = true;
            //ddlCiudad.Enabled = true;
            ChkAutoAssignPolicy.Enabled = true;

            ddlPrMedicalLimits.Enabled = false;

            txtCorporation.Enabled = true;
            txtCustomerName2.Enabled = true;
            ddlPrimaryLimits1.Enabled = true;
            ddlLimits.Enabled = true;
            ddlPolicyClass.Enabled = true;
            txtIsoCode.Enabled = true;
            txtPRate4.Enabled = true;
            txtRate4.Enabled = true;

            txtCorporation.Enabled = true;
            txtDiscountP.Enabled = true;
            txtDiscount.Enabled = true;
            txtTotalPrimaryPremium.Enabled = false;
            txtTotalExcessPremium.Enabled = false;

            txtRateTN1.Enabled = true;
            txtRateTN2.Enabled = true;
            txtRateTN3.Enabled = true;
            txtRateTN4.Enabled = true;
            txtRateTN5.Enabled = true;
            txtRateTN6.Enabled = true;
            txtPrimaryTN1.Enabled = false;
            txtPrimaryTN2.Enabled = false;
            txtPrimaryTN3.Enabled = false;
            txtPrimaryTN4.Enabled = false;
            txtPrimaryTN5.Enabled = false;
            txtPremiumTN1.Enabled = false;
            txtPremiumTN2.Enabled = false;
            txtPremiumTN3.Enabled = false;
            txtPremiumTN4.Enabled = false;
            txtPremiumTN5.Enabled = false;
            txtQuantityTN1.Enabled = true;
            txtQuantityTN2.Enabled = true;
            txtQuantityTN3.Enabled = true;
            txtQuantityTN4.Enabled = true;
            txtQuantityTN5.Enabled = true;
            txtQuantityTN6.Enabled = true;
            txtTotPremTN1.Enabled = false;
            txtTotPremTN2.Enabled = false;
            txtTotPremTN3.Enabled = false;
            txtTotPremTN4.Enabled = false;
            txtTotPremTN5.Enabled = false;
            txtTotPremTN6.Enabled = false;

            txtERateTN1.Enabled = true;
            txtERateTN2.Enabled = true;
            txtERateTN3.Enabled = true;
            txtERateTN4.Enabled = true;
            txtERateTN5.Enabled = true;
            txtERateTN6.Enabled = true;
            txtExcessTN1.Enabled = false;
            txtExcessTN2.Enabled = false;
            txtExcessTN3.Enabled = false;
            txtExcessTN4.Enabled = false;
            txtExcessTN5.Enabled = false;
            txtEPremiumTN1.Enabled = false;
            txtEPremiumTN2.Enabled = false;
            txtEPremiumTN3.Enabled = false;
            txtEPremiumTN4.Enabled = false;
            txtEPremiumTN5.Enabled = false;
            txtEQuantityTN1.Enabled = true;
            txtEQuantityTN2.Enabled = true;
            txtEQuantityTN3.Enabled = true;
            txtEQuantityTN4.Enabled = true;
            txtEQuantityTN5.Enabled = true;
            txtEQuantityTN6.Enabled = true;
            txtETotPremTN1.Enabled = false;
            txtETotPremTN2.Enabled = false;
            txtETotPremTN3.Enabled = false;
            txtETotPremTN4.Enabled = false;
            txtETotPremTN5.Enabled = false;
            txtETotPremTN6.Enabled = false;

            txtTotalPrimaryCorporate.Enabled = false;
            txtTotalExcessCorporate.Enabled = false;

            this.DtGridCorpaoratePol.Columns[0].Visible = true;
            this.DtGridCorpaoratePol.Columns[9].Visible = true;
        }

        private void DisableControls()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            btnEdit.Visible = true;
            BtnExit.Visible = true;
            btnPrint.Visible = true;
            btnPrintCertificate.Visible = false;
            btnAddNew.Visible = true;
            BtnSave.Visible = false;
            btnCalcCharge.Visible = false;
            cmdCancel.Visible = false;
            Button2.Visible = false;
            Button3.Visible = false;
            btnCancellation.Visible = true;
            btnDelete.Visible = true;

            if (taskControl.IsPolicy)
            {
                btnConvert.Visible = false;
                btnConvertPrimary.Visible = false;
                btnRenew.Visible = true;
                txtCorporation.Visible = false;
                txtCustomerName2.Visible = false;
                pnlPolicy.Visible = true;
                ddlSelectedAgent.Visible = false;
                Label8.Visible = false;
                Label18.Visible = false;

                if (taskControl.PolicyType.Trim() == "CP")
                {
                    btnPrintCertificate.Visible = true;
                    pnlPrimary.Visible = true;
                    pnlExcess.Visible = false;
                    Label40.Visible = true;
                    Label16.Visible = false;
                    Label17.Visible = true;
                    Label15.Visible = false;
                    Label7.Visible = true;
                    Label39.Visible = false;
                    txtDiscountP.Visible = true;
                    txtDiscount.Visible = false;
                    txtTotalPrimaryPremium.Visible = true;
                    txtTotalExcessPremium.Visible = false;
                    Label13.Visible = true;
                    Label9.Visible = false;
                    txtTotalPrimaryCorporate.Visible = true;
                    txtTotalExcessCorporate.Visible = false;
                }
                else
                {
                    btnPrintCertificate.Visible = false;
                    pnlPrimary.Visible = false;
                    pnlExcess.Visible = true;
                    Label40.Visible = false;
                    Label16.Visible = true;
                    Label17.Visible = false;
                    Label15.Visible = true;
                    Label7.Visible = false;
                    Label39.Visible = true;
                    txtDiscountP.Visible = false;
                    txtDiscount.Visible = true;
                    txtTotalPrimaryPremium.Visible = false;
                    txtTotalExcessPremium.Visible = true;
                    Label13.Visible = false;
                    Label9.Visible = true;
                    txtTotalPrimaryCorporate.Visible = false;
                    txtTotalExcessCorporate.Visible = true;
                }
            }
            else
            {
                btnConvert.Visible = false;
                btnConvertPrimary.Visible = false;
                btnRenew.Visible = false;
                txtCorporation.Visible = true;
                txtCustomerName2.Visible = true;
                pnlPolicy.Visible = false;
                pnlPrimary.Visible = true;
                pnlExcess.Visible = true;
                Label40.Visible = true;
                Label16.Visible = true;
                Label17.Visible = true;
                Label15.Visible = true;
                Label8.Visible = true;
                Label18.Visible = true;
                Label7.Visible = true;
                Label39.Visible = true;
                txtDiscountP.Visible = true;
                txtDiscount.Visible = true;
                txtTotalPrimaryPremium.Visible = true;
                txtTotalExcessPremium.Visible = true;
                Label13.Visible = true;
                Label9.Visible = true;
                txtTotalPrimaryCorporate.Visible = true;
                txtTotalExcessCorporate.Visible = true;
            }

            TxtCustomerNo.Enabled = false;
            TxtFirstName.Enabled = false;
            TxtInitial.Enabled = false;
            txtLastname1.Enabled = false;
            txtLastname2.Enabled = false;
            TxtAddrs1.Enabled = false;
            TxtAddrs2.Enabled = false;
            TxtCity.Enabled = false;
            TxtState.Enabled = false;
            TxtZip.Enabled = false;
            txtHomePhone.Enabled = false;
            txtWorkPhone.Enabled = false;
            TxtCellular.Enabled = false;
            txtEmail.Enabled = false;
            txtLicense.Enabled = false;
            TxtPolicyNo.Enabled = false;
            TxtCertificate.Enabled = false;
            TxtPolicyType.Enabled = false;
            TxtSufijo.Enabled = false;
            TxtAnniversary.Enabled = false;
            TxtTerm.Enabled = false;
            ddlCorparation.Enabled = false;
            ddlSelectedAgent.Enabled = false;
            TxtRetroactiveDate.Enabled = false;
            txtEffDt.Enabled = false;
            txtExpDt.Enabled = false;
            txtEntryDate.Enabled = false;
            TxtCharge.Enabled = false;
            TxtTotalPremium.Enabled = false;
            TxtComments.Enabled = false;

            ddlOriginatedAt.Enabled = false;
            ddlInsuranceCompany.Enabled = false;
            ddlAgency.Enabled = false;
            ddlAgent.Enabled = false;
            ddlPolicyClass.Enabled = false;
            ddlFinancial.Enabled = false;
            ddlOtherSpecialty.Enabled = false;
            chkPaymentGA.Enabled = false;
            //ddlCiudad.Enabled = false;
            ChkAutoAssignPolicy.Enabled = false;
            ddlPrMedicalLimits.Enabled = false;

            txtCorporation.Enabled = false;
            txtCustomerName2.Enabled = false;
            ddlPrimaryLimits1.Enabled = false;
            ddlLimits.Enabled = false;
            ddlPolicyClass.Enabled = false;
            txtIsoCode.Enabled = false;
            txtPRate4.Enabled = false;
            txtRate4.Enabled = false;

            txtCorporation.Enabled = false;
            txtDiscountP.Enabled = false;
            txtDiscount.Enabled = false;
            txtTotalPrimaryPremium.Enabled = false;
            txtTotalExcessPremium.Enabled = false;

            txtRateTN1.Enabled = false;
            txtRateTN2.Enabled = false;
            txtRateTN3.Enabled = false;
            txtRateTN4.Enabled = false;
            txtRateTN5.Enabled = false;
            txtRateTN6.Enabled = false;
            txtPrimaryTN1.Enabled = false;
            txtPrimaryTN2.Enabled = false;
            txtPrimaryTN3.Enabled = false;
            txtPrimaryTN4.Enabled = false;
            txtPrimaryTN5.Enabled = false;
            txtPremiumTN1.Enabled = false;
            txtPremiumTN2.Enabled = false;
            txtPremiumTN3.Enabled = false;
            txtPremiumTN4.Enabled = false;
            txtPremiumTN5.Enabled = false;
            txtQuantityTN1.Enabled = false;
            txtQuantityTN2.Enabled = false;
            txtQuantityTN3.Enabled = false;
            txtQuantityTN4.Enabled = false;
            txtQuantityTN5.Enabled = false;
            txtQuantityTN6.Enabled = false;
            txtTotPremTN1.Enabled = false;
            txtTotPremTN2.Enabled = false;
            txtTotPremTN3.Enabled = false;
            txtTotPremTN4.Enabled = false;
            txtTotPremTN5.Enabled = false;
            txtTotPremTN6.Enabled = false;

            txtERateTN1.Enabled = false;
            txtERateTN2.Enabled = false;
            txtERateTN3.Enabled = false;
            txtERateTN4.Enabled = false;
            txtERateTN5.Enabled = false;
            txtERateTN6.Enabled = false;
            txtExcessTN1.Enabled = false;
            txtExcessTN2.Enabled = false;
            txtExcessTN3.Enabled = false;
            txtExcessTN4.Enabled = false;
            txtExcessTN5.Enabled = false;
            txtEPremiumTN1.Enabled = false;
            txtEPremiumTN2.Enabled = false;
            txtEPremiumTN3.Enabled = false;
            txtEPremiumTN4.Enabled = false;
            txtEPremiumTN5.Enabled = false;
            txtEQuantityTN1.Enabled = false;
            txtEQuantityTN2.Enabled = false;
            txtEQuantityTN3.Enabled = false;
            txtEQuantityTN4.Enabled = false;
            txtEQuantityTN5.Enabled = false;
            txtEQuantityTN6.Enabled = false;
            txtETotPremTN1.Enabled = false;
            txtETotPremTN2.Enabled = false;
            txtETotPremTN3.Enabled = false;
            txtETotPremTN4.Enabled = false;
            txtETotPremTN5.Enabled = false;
            txtETotPremTN6.Enabled = false;

            txtTotalPrimaryCorporate.Enabled = false;
            txtTotalExcessCorporate.Enabled = false;

            this.DtGridCorpaoratePol.Columns[0].Visible = false;
            this.DtGridCorpaoratePol.Columns[9].Visible = false;

            VerifyAccess();
        }

        #region VerifyAccess
        private void VerifyAccess()
        {
            TaskControl.CorporatePolicyQuote taskControl = (TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            Login.Login cp = HttpContext.Current.User as Login.Login;

            if (!cp.IsInRole("BTNCONVERTPRIMARYCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnConvertPrimary.Visible = false;
            }
            else
            {
                this.btnConvertPrimary.Visible = true;
            }

            if (!cp.IsInRole("BTNCONVERTCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnConvert.Visible = false;
            }
            else
            {
                this.btnConvert.Visible = true;
            }

            if (!cp.IsInRole("BTNPAYMENTCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnPayments.Visible = false;
            }
            else
            {
                this.btnPayments.Visible = true;
            }

            if (!cp.IsInRole("BTNCANCELLATIONCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnCancellation.Visible = false;
            }
            else
            {
                this.btnCancellation.Visible = true;
            }

            if (!cp.IsInRole("BTNDELETECORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnDelete.Visible = false;
            }
            else
            {
                this.btnDelete.Visible = true;
            }

            if (!cp.IsInRole("BTNADDCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnAddNew.Visible = false;
            }
            else
            {
                this.btnAddNew.Visible = true;
            }

            if (!cp.IsInRole("BTNEDITCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnEdit.Visible = false;
            }
            else
            {
                this.btnEdit.Visible = true;
            }

            if (!cp.IsInRole("BTNPRINTCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnPrint.Visible = false;
            }
            else
            {
                this.btnPrint.Visible = true;
            }

            if (!cp.IsInRole("BTNRENEWCORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.btnRenew.Visible = false;
            }
            else
            {
                this.btnRenew.Visible = true;
            }

            if (!cp.IsInRole("BTNSAVECORPORATE") && !cp.IsInRole("ADMINISTRATOR"))
            {
                this.BtnSave.Visible = false;
            }
            else
            {
                this.BtnSave.Visible = true;
            }

        }
        #endregion

        private void FillTextDDlAgent()
        {
            TaskControl.CorporatePolicyQuote taskControl = (TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            taskControl.AgentSelectedTable = TaskControl.Policy.GetSelectedAgent(taskControl.TaskControlID);

            Session.Add("TaskControl", taskControl);

            SetddlSelectedAgent(taskControl.AgentSelectedTable);
            ddlSelectedAgentOrder();

            VerifyLabelAgent(ddlSelectedAgent.Items.Count, 1, false);
        }

        private void FillTextControl()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            Login.Login cp = HttpContext.Current.User as Login.Login;
            int userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);

            if (taskControl.IsPolicy)
            {
                if (taskControl.Mode != 1)
                    FillTextDDlAgent();

                if (taskControl.OriginatedAt != 0)
                    ddlOriginatedAt.SelectedIndex = ddlOriginatedAt.Items.IndexOf(
                        ddlOriginatedAt.Items.FindByValue(taskControl.OriginatedAt.ToString()));

                if (taskControl.InsuranceCompany != "0")
                    ddlInsuranceCompany.SelectedIndex = ddlInsuranceCompany.Items.IndexOf(
                        ddlInsuranceCompany.Items.FindByValue(taskControl.InsuranceCompany.ToString()));

                if (taskControl.Agency != "0")
                    ddlAgency.SelectedIndex = ddlAgency.Items.IndexOf(
                        ddlAgency.Items.FindByValue(taskControl.Agency));

                if (taskControl.Agent != "0")
                    ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                        ddlAgent.Items.FindByValue(taskControl.Agent));

                if (taskControl.CompanyDealer != "0")
                    ddlCorparation.SelectedIndex = ddlCorparation.Items.IndexOf(
                        ddlCorparation.Items.FindByValue(taskControl.CompanyDealer));

                if (taskControl.FinancialID != 0)
                    ddlFinancial.SelectedIndex = ddlFinancial.Items.IndexOf(
                        ddlFinancial.Items.FindByValue(taskControl.FinancialID.ToString()));

                if (taskControl.OtherSpecialtyID != 0)
                    ddlOtherSpecialty.SelectedIndex = ddlOtherSpecialty.Items.IndexOf(
                        ddlOtherSpecialty.Items.FindByValue(taskControl.OtherSpecialtyID.ToString()));

                if (taskControl.Notification30Flag && taskControl.Notification15Flag && taskControl.CancellationFlag)
                    chkPaymentGA.Checked = true;

                //ddlCiudad.SelectedIndex = 0;
                //if (taskControl.Customer.City != "")
                //{
                //    for (int i = 0; ddlCiudad.Items.Count - 1 >= i; i++)
                //    {
                //        if (ddlCiudad.Items[i].Text.Trim() == taskControl.Customer.City.ToString().Trim())
                //        {
                //            ddlCiudad.SelectedIndex = i;
                //            i = ddlCiudad.Items.Count - 1;
                //        }
                //    }
                //}

                LblStatus.Text = taskControl.Status;

                TxtCustomerNo.Text = taskControl.Customer.CustomerNo;
                TxtFirstName.Text = taskControl.Customer.FirstName;
                TxtInitial.Text = taskControl.Customer.Initial;
                txtLastname1.Text = taskControl.Customer.LastName1;
                txtLastname2.Text = taskControl.Customer.LastName2;
                TxtAddrs1.Text = taskControl.Customer.Address1;
                TxtAddrs2.Text = taskControl.Customer.Address2;
                TxtCity.Text = taskControl.Customer.City;
                TxtState.Text = taskControl.Customer.State;
                TxtZip.Text = taskControl.Customer.ZipCode;
                txtHomePhone.Text = taskControl.Customer.HomePhone;
                txtWorkPhone.Text = taskControl.Customer.JobPhone;
                TxtCellular.Text = taskControl.Customer.Cellular;
                txtEmail.Text = taskControl.Customer.Email;
                txtLicense.Text = taskControl.Customer.License;
                TxtPolicyNo.Text = taskControl.PolicyNo;
                TxtCertificate.Text = taskControl.Certificate;
                TxtPolicyType.Text = taskControl.PolicyType;
                TxtSufijo.Text = taskControl.Suffix;
                TxtAnniversary.Text = taskControl.Anniversary;
                TxtTerm.Text = taskControl.Term.ToString();
                TxtRetroactiveDate.Text = taskControl.RetroactiveDate;
                txtEffDt.Text = taskControl.EffectiveDate;
                txtExpDt.Text = taskControl.ExpirationDate;
                txtEntryDate.Text = taskControl.EntryDate.ToShortDateString();
                TxtCharge.Text = taskControl.Charge.ToString("###,###.00");
                TxtTotalPremium.Text = (taskControl.TotalPremium + taskControl.Charge).ToString("###,###.00");
                TxtComments.Text = taskControl.Comments.ToString();
                ChkAutoAssignPolicy.Checked = taskControl.AutoAssignPolicy;
            }

            lblTCID.Text = taskControl.TaskControlID.ToString();
            txtCorporation.Text = taskControl.Corporate.ToString();
            txtDiscountP.Text = taskControl.DiscountP.ToString();
            txtDiscount.Text = taskControl.Discount.ToString();
            txtTotalPrimaryPremium.Text = taskControl.TotalPrimaryPremium.ToString();
            txtTotalExcessPremium.Text = taskControl.TotalExcessPremium.ToString();

            txtRateTN1.Text = taskControl.RateTN1.ToString("###,##0");
            txtRateTN2.Text = taskControl.RateTN2.ToString("###,##0");
            txtRateTN3.Text = taskControl.RateTN3.ToString("###,##0");
            txtRateTN4.Text = taskControl.RateTN4.ToString("###,##0");
            txtRateTN5.Text = taskControl.RateTN5.ToString("###,##0");
            txtRateTN6.Text = taskControl.RateTN6.ToString("###,##0");
            txtPrimaryTN1.Text = taskControl.PrimaryTN1.ToString("###,###.00");
            txtPrimaryTN2.Text = taskControl.PrimaryTN2.ToString("###,###.00");
            txtPrimaryTN3.Text = taskControl.PrimaryTN3.ToString("###,###.00");
            txtPrimaryTN4.Text = taskControl.PrimaryTN4.ToString("###,###.00");
            txtPrimaryTN5.Text = taskControl.PrimaryTN5.ToString("###,###.00");
            txtPremiumTN1.Text = taskControl.PremiumTN1.ToString("###,###.00");
            txtPremiumTN2.Text = taskControl.PremiumTN2.ToString("###,###.00");
            txtPremiumTN3.Text = taskControl.PremiumTN3.ToString("###,###.00");
            txtPremiumTN4.Text = taskControl.PremiumTN4.ToString("###,###.00");
            txtPremiumTN5.Text = taskControl.PremiumTN5.ToString("###,###.00");
            txtQuantityTN1.Text = taskControl.QuantityTN1.ToString();
            txtQuantityTN2.Text = taskControl.QuantityTN2.ToString();
            txtQuantityTN3.Text = taskControl.QuantityTN3.ToString();
            txtQuantityTN4.Text = taskControl.QuantityTN4.ToString();
            txtQuantityTN5.Text = taskControl.QuantityTN5.ToString();
            txtQuantityTN6.Text = taskControl.QuantityTN6.ToString();
            txtTotPremTN1.Text = taskControl.TotPremTN1.ToString("###,###.00");
            txtTotPremTN2.Text = taskControl.TotPremTN2.ToString("###,###.00");
            txtTotPremTN3.Text = taskControl.TotPremTN3.ToString("###,###.00");
            txtTotPremTN4.Text = taskControl.TotPremTN4.ToString("###,###.00");
            txtTotPremTN5.Text = taskControl.TotPremTN5.ToString("###,###.00");
            txtTotPremTN6.Text = taskControl.TotPremTN6.ToString("###,###.00");

            txtERateTN1.Text = taskControl.ERateTN1.ToString("###,##0");
            txtERateTN2.Text = taskControl.ERateTN2.ToString("###,##0");
            txtERateTN3.Text = taskControl.ERateTN3.ToString("###,##0");
            txtERateTN4.Text = taskControl.ERateTN4.ToString("###,##0");
            txtERateTN5.Text = taskControl.ERateTN5.ToString("###,##0");
            txtERateTN6.Text = taskControl.ERateTN6.ToString("###,##0");
            txtExcessTN1.Text = taskControl.ExcessTN1.ToString("###,###.00");
            txtExcessTN2.Text = taskControl.ExcessTN2.ToString("###,###.00");
            txtExcessTN3.Text = taskControl.ExcessTN3.ToString("###,###.00");
            txtExcessTN4.Text = taskControl.ExcessTN4.ToString("###,###.00");
            txtExcessTN5.Text = taskControl.ExcessTN5.ToString("###,###.00");
            txtEPremiumTN1.Text = taskControl.EPremiumTN1.ToString("###,###.00");
            txtEPremiumTN2.Text = taskControl.EPremiumTN2.ToString("###,###.00");
            txtEPremiumTN3.Text = taskControl.EPremiumTN3.ToString("###,###.00");
            txtEPremiumTN4.Text = taskControl.EPremiumTN4.ToString("###,###.00");
            txtEPremiumTN5.Text = taskControl.EPremiumTN5.ToString("###,###.00");
            txtEQuantityTN1.Text = taskControl.EQuantityTN1.ToString();
            txtEQuantityTN2.Text = taskControl.EQuantityTN2.ToString();
            txtEQuantityTN3.Text = taskControl.EQuantityTN3.ToString();
            txtEQuantityTN4.Text = taskControl.EQuantityTN4.ToString();
            txtEQuantityTN5.Text = taskControl.EQuantityTN5.ToString();
            txtEQuantityTN6.Text = taskControl.EQuantityTN6.ToString();
            txtETotPremTN1.Text = taskControl.ETotPremTN1.ToString("###,###.00");
            txtETotPremTN2.Text = taskControl.ETotPremTN2.ToString("###,###.00");
            txtETotPremTN3.Text = taskControl.ETotPremTN3.ToString("###,###.00");
            txtETotPremTN4.Text = taskControl.ETotPremTN4.ToString("###,###.00");
            txtETotPremTN5.Text = taskControl.ETotPremTN5.ToString("###,###.00");
            txtETotPremTN6.Text = taskControl.ETotPremTN6.ToString("###,###.00");

            txtTotalPrimaryCorporate.Text = taskControl.TotalPrimaryCorporate.ToString("###,###.00");
            txtTotalExcessCorporate.Text = taskControl.TotalExcessCorporate.ToString("###,###.00");

            if (taskControl.Mode != 1)
            {
                FillCorporatePolicyGrid();
                if(taskControl.PolicyType.Trim()=="CP")
                    ddlPrMedicalLimits.SelectedIndex = ddlPrMedicalLimits.Items.IndexOf(ddlPrMedicalLimits.Items.FindByText(DtGridCorpaoratePol.Items[0].Cells[3].Text.Trim()));
                else
                    ddlPrMedicalLimits.SelectedIndex = ddlPrMedicalLimits.Items.IndexOf(ddlPrMedicalLimits.Items.FindByText(DtGridCorpaoratePol.Items[0].Cells[4].Text.Trim()));

            }
        }

        private void FillProperties()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            if (taskControl.IsPolicy)
            {
                taskControl.LbxAgentSelected = ddlSelectedAgent;
                if (ddlSelectedAgent.Items.Count != 0)
                {
                    taskControl.Agent = ddlSelectedAgent.Items[0].Value.Split("|".ToCharArray())[1];
                }
                else
                {
                    taskControl.Agent = "000";
                }

                //Agency
                if (ddlAgency.SelectedIndex > 0 && ddlAgency.SelectedItem != null)
                    taskControl.Agency = ddlAgency.SelectedItem.Value;
                else
                    taskControl.Agency = "000";

                //Agent
                if (ddlAgent.SelectedIndex > 0 && ddlAgent.SelectedItem != null)
                    taskControl.Agent = ddlAgent.SelectedItem.Value;
                else
                    taskControl.Agent = "000";

                //Corporation
                if (ddlCorparation.SelectedIndex > 0 && ddlCorparation.SelectedItem != null)
                    taskControl.CompanyDealer = ddlCorparation.SelectedItem.Value;
                else
                    taskControl.CompanyDealer = "000";

                //InsuranceCompany
                if (ddlInsuranceCompany.SelectedIndex > 0 && ddlInsuranceCompany.SelectedItem != null)
                    taskControl.InsuranceCompany = ddlInsuranceCompany.SelectedItem.Value;
                else
                    taskControl.InsuranceCompany = "000";

                //Corparation
                if (ddlCorparation.SelectedIndex > 0 && ddlCorparation.SelectedItem != null)
                    taskControl.CompanyDealer = ddlCorparation.SelectedItem.Value;
                else
                    taskControl.CompanyDealer = "000";

                //Originated At
                if (ddlOriginatedAt.SelectedIndex > 0 && ddlOriginatedAt.SelectedItem != null)
                {
                    taskControl.OriginatedAt = int.Parse(ddlOriginatedAt.SelectedItem.Value.ToString());
                }

                //Financial
                if (ddlFinancial.SelectedIndex > 0 && ddlFinancial.SelectedItem != null)
                {
                    taskControl.FinancialID = int.Parse(ddlFinancial.SelectedItem.Value.ToString());
                }
                else { taskControl.FinancialID = 0; }

                //OtherSpecialty
                if (ddlOtherSpecialty.SelectedIndex > 0 && ddlOtherSpecialty.SelectedItem != null)
                {
                    taskControl.OtherSpecialtyID = int.Parse(ddlOtherSpecialty.SelectedItem.Value.ToString());
                }
                else { taskControl.OtherSpecialtyID = 0; }

                //Check Payments by GA
                taskControl.Notification30Flag = chkPaymentGA.Checked;
                taskControl.Notification15Flag = chkPaymentGA.Checked;
                taskControl.CancellationFlag = chkPaymentGA.Checked;

                //Ciudad
                //if (ddlCiudad.SelectedIndex > 0 && ddlCiudad.SelectedItem != null)
                //    taskControl.Customer.City = ddlCiudad.SelectedItem.Text;
                //else
                //    taskControl.Customer.City = "";

                taskControl.SupplierID = "000";

                taskControl.Customer.CustomerNo = TxtCustomerNo.Text.Trim();
                taskControl.Customer.FirstName = TxtFirstName.Text.ToUpper().Trim();
                taskControl.Customer.Initial = TxtInitial.Text.ToUpper().Trim();
                taskControl.Customer.LastName1 = txtLastname1.Text.ToUpper().Trim();
                taskControl.Customer.LastName2 = txtLastname2.Text.ToUpper().Trim();
                taskControl.Customer.Address1 = TxtAddrs1.Text.ToUpper().Trim();
                taskControl.Customer.Address2 = TxtAddrs2.Text.ToUpper().Trim();
                taskControl.Customer.City			 = TxtCity.Text.ToUpper().Trim();
                taskControl.Customer.State = TxtState.Text.ToUpper().Trim();
                taskControl.Customer.ZipCode = TxtZip.Text.ToUpper().Trim();
                taskControl.Customer.HomePhone = txtHomePhone.Text.Trim();
                taskControl.Customer.JobPhone = txtWorkPhone.Text.Trim();
                taskControl.Customer.Cellular = TxtCellular.Text.Trim();
                taskControl.Customer.Email = txtEmail.Text.Trim();
                taskControl.Customer.License = txtLicense.Text.Trim();
                taskControl.Comments = TxtComments.Text.Trim().ToUpper();

                taskControl.PolicyNo = TxtPolicyNo.Text.Trim().ToUpper().Replace(" ", "");
                taskControl.Certificate = TxtCertificate.Text.Trim().ToUpper();
                taskControl.PolicyType = TxtPolicyType.Text.Trim().ToUpper();
                taskControl.Suffix = TxtSufijo.Text.Trim();
                taskControl.Anniversary = TxtAnniversary.Text.Trim();
                taskControl.Term = int.Parse(TxtTerm.Text.Trim());
                taskControl.EffectiveDate = txtEffDt.Text.Trim();

                taskControl.RetroactiveDate = TxtRetroactiveDate.Text;

                if (taskControl.ExpirationDate.Trim() == string.Empty) // && this.TxtTerm.Text.Trim() != string.Empty)
                {
                    if (this.TxtTerm.Text.Trim() == string.Empty)
                    {
                        this.TxtTerm.Text = "0";
                    }
                    taskControl.ExpirationDate = DateTime.Parse(this.txtEffDt.Text).AddMonths(int.Parse(this.TxtTerm.Text.Trim())).ToShortDateString();
                    this.txtExpDt.Text = taskControl.ExpirationDate;
                }
                else
                {
                    if (this.txtExpDt.Text.Trim() != string.Empty)
                    {
                        taskControl.ExpirationDate = DateTime.Parse(this.txtEffDt.Text).AddMonths(int.Parse(this.TxtTerm.Text.Trim())).ToShortDateString();
                        this.txtExpDt.Text = taskControl.ExpirationDate;
                    }
                }

                taskControl.EntryDate = DateTime.Parse(txtEntryDate.Text);


                if (TxtCharge.Text.Trim() == "")
                    taskControl.Charge = 0.00;
                else
                    taskControl.Charge = double.Parse(TxtCharge.Text.ToString().Trim());

                if (TxtTotalPremium.Text.Trim() == "")
                    taskControl.TotalPremium = 0.00;
                else
                    taskControl.TotalPremium = double.Parse(TxtTotalPremium.Text.ToString().Trim()) -
                        double.Parse(TxtCharge.Text.ToString().Trim());

                if (ChkAutoAssignPolicy.Checked)
                    taskControl.AutoAssignPolicy = true;
                else
                    taskControl.AutoAssignPolicy = false;
            }

            taskControl.Corporate = txtCorporation.Text.Trim().ToUpper();
            taskControl.DiscountP = double.Parse(txtDiscountP.Text.Replace("%", ""));
            taskControl.Discount = double.Parse(txtDiscount.Text.Replace("%", ""));
            taskControl.TotalPrimaryPremium = double.Parse(txtTotalPrimaryPremium.Text);
            taskControl.TotalExcessPremium = double.Parse(txtTotalExcessPremium.Text);

            taskControl.RateTN1 = double.Parse(txtRateTN1.Text.Replace("%", ""));
            taskControl.RateTN2 = double.Parse(txtRateTN2.Text.Replace("%", ""));
            taskControl.RateTN3 = double.Parse(txtRateTN3.Text.Replace("%", ""));
            taskControl.RateTN4 = double.Parse(txtRateTN4.Text.Replace("%", ""));
            taskControl.RateTN5 = double.Parse(txtRateTN5.Text.Replace("%", ""));
            taskControl.RateTN6 = double.Parse(txtRateTN6.Text.Replace("%", ""));
            taskControl.PrimaryTN1 = double.Parse(txtPrimaryTN1.Text);
            taskControl.PrimaryTN2 = double.Parse(txtPrimaryTN2.Text);
            taskControl.PrimaryTN3 = double.Parse(txtPrimaryTN3.Text);
            taskControl.PrimaryTN4 = double.Parse(txtPrimaryTN4.Text);
            taskControl.PrimaryTN5 = double.Parse(txtPrimaryTN5.Text);
            taskControl.PremiumTN1 = double.Parse(txtPremiumTN1.Text);
            taskControl.PremiumTN2 = double.Parse(txtPremiumTN2.Text);
            taskControl.PremiumTN3 = double.Parse(txtPremiumTN3.Text);
            taskControl.PremiumTN4 = double.Parse(txtPremiumTN4.Text);
            taskControl.PremiumTN5 = double.Parse(txtPremiumTN5.Text);
            taskControl.QuantityTN1 = int.Parse(txtQuantityTN1.Text);
            taskControl.QuantityTN2 = int.Parse(txtQuantityTN2.Text);
            taskControl.QuantityTN3 = int.Parse(txtQuantityTN3.Text);
            taskControl.QuantityTN4 = int.Parse(txtQuantityTN4.Text);
            taskControl.QuantityTN5 = int.Parse(txtQuantityTN5.Text);
            taskControl.QuantityTN6 = int.Parse(txtQuantityTN6.Text);
            taskControl.TotPremTN1 = double.Parse(txtTotPremTN1.Text);
            taskControl.TotPremTN2 = double.Parse(txtTotPremTN2.Text);
            taskControl.TotPremTN3 = double.Parse(txtTotPremTN3.Text);
            taskControl.TotPremTN4 = double.Parse(txtTotPremTN4.Text);
            taskControl.TotPremTN5 = double.Parse(txtTotPremTN5.Text);
            taskControl.TotPremTN6 = double.Parse(txtTotPremTN6.Text);
            taskControl.ERateTN1 = double.Parse(txtERateTN1.Text.Replace("%", ""));
            taskControl.ERateTN2 = double.Parse(txtERateTN2.Text.Replace("%", ""));
            taskControl.ERateTN3 = double.Parse(txtERateTN3.Text.Replace("%", ""));
            taskControl.ERateTN4 = double.Parse(txtERateTN4.Text.Replace("%", ""));
            taskControl.ERateTN5 = double.Parse(txtERateTN5.Text.Replace("%", ""));
            taskControl.ERateTN6 = double.Parse(txtERateTN6.Text.Replace("%", ""));
            taskControl.ExcessTN1 = double.Parse(txtExcessTN1.Text);
            taskControl.ExcessTN2 = double.Parse(txtExcessTN2.Text);
            taskControl.ExcessTN3 = double.Parse(txtExcessTN3.Text);
            taskControl.ExcessTN4 = double.Parse(txtExcessTN4.Text);
            taskControl.ExcessTN5 = double.Parse(txtExcessTN5.Text);
            taskControl.EPremiumTN1 = double.Parse(txtEPremiumTN1.Text);
            taskControl.EPremiumTN2 = double.Parse(txtEPremiumTN2.Text);
            taskControl.EPremiumTN3 = double.Parse(txtEPremiumTN3.Text);
            taskControl.EPremiumTN4 = double.Parse(txtEPremiumTN4.Text);
            taskControl.EPremiumTN5 = double.Parse(txtEPremiumTN5.Text);
            taskControl.EQuantityTN1 = int.Parse(txtEQuantityTN1.Text);
            taskControl.EQuantityTN2 = int.Parse(txtEQuantityTN2.Text);
            taskControl.EQuantityTN3 = int.Parse(txtEQuantityTN3.Text);
            taskControl.EQuantityTN4 = int.Parse(txtEQuantityTN4.Text);
            taskControl.EQuantityTN5 = int.Parse(txtEQuantityTN5.Text);
            taskControl.EQuantityTN6 = int.Parse(txtEQuantityTN6.Text);
            taskControl.ETotPremTN1 = double.Parse(txtETotPremTN1.Text);
            taskControl.ETotPremTN2 = double.Parse(txtETotPremTN2.Text);
            taskControl.ETotPremTN3 = double.Parse(txtETotPremTN3.Text);
            taskControl.ETotPremTN4 = double.Parse(txtETotPremTN4.Text);
            taskControl.ETotPremTN5 = double.Parse(txtETotPremTN5.Text);
            taskControl.ETotPremTN6 = double.Parse(txtETotPremTN6.Text);
            taskControl.TotalPrimaryCorporate = double.Parse(txtTotalPrimaryCorporate.Text);
            taskControl.TotalExcessCorporate = double.Parse(txtTotalExcessCorporate.Text);
        }

        private void FillCorporatePolicyGrid()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            DataTable dt = EPolicy.TaskControl.CorporatePolicyQuote.GetCorporatePolicyDetailByTaskControlID(taskControl.TaskControlID, taskControl.IsPolicy);

            if (dt.Rows.Count != 0)
            {
                DtGridCorpaoratePol.DataSource = dt;
                DtGridCorpaoratePol.DataBind();
                DtGridCorpaoratePol.Visible = true;
            }
            else
            {
                this.DtGridCorpaoratePol.DataSource = null;
                this.DtGridCorpaoratePol.DataBind();
            }
        }

        private DataTable SearchPolicy(string policyType, string policyNo)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("PolicyType", SqlDbType.VarChar, 3, policyType.ToString(), ref cookItems);
            DbRequestXmlCooker.AttachCookItem("PolicyNo", SqlDbType.VarChar, 11, policyNo.ToString(), ref cookItems);

            DBRequest exec = new DBRequest();

            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetPolicyByPolicyTypeAndPolicyNo", xmlDoc);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not find the Policy.", ex);
            }

            return dt;
        }

        protected void Button2_Click(object sender, EventArgs e)
        {
            try
            {
                EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

                if (txtCorporatePolicyQuoteID.Text.Trim() != "")
                {
                    taskControl.CorporatePolicyDetailCollection.Rows.RemoveAt(int.Parse(txtCorporatePolicyQuoteID.Text));
                    taskControl.CorporatePolicyDetailCollection.AcceptChanges();
                }

                //Add temp Table
                DataTable dt = null;
                DataRow myRow = taskControl.CorporatePolicyDetailCollection.NewRow();

                myRow["TaskControlID"] = "0";
                myRow["CustomerName"] = txtCustomerName2.Text.Trim().ToUpper();
                myRow["PrimaryRate"] = ddlPrimaryLimits1.SelectedItem.Text.Trim();
                myRow["ExcessRate"] = ddlLimits.SelectedItem.Text.Trim();
                myRow["Specialty"] = ddlPolicyClass.SelectedItem.Text.Trim();
                myRow["IsoCode"] = txtIsoCode.Text.Trim();
                myRow["TotalPrimaryPremium"] = txtPRate4.Text.Trim();
                myRow["TotalExcessPremium"] = txtRate4.Text.Trim();

                taskControl.CorporatePolicyDetailCollection.Rows.Add(myRow);
                taskControl.CorporatePolicyDetailCollection.AcceptChanges();
                dt = taskControl.CorporatePolicyDetailCollection;

                this.DtGridCorpaoratePol.CurrentPageIndex = 0;
                this.DtGridCorpaoratePol.Visible = true;
                this.DtGridCorpaoratePol.DataSource = dt;
                this.DtGridCorpaoratePol.DataBind();
                this.DtGridCorpaoratePol.Visible = true;

                //Calculate Premium
                double totPprem = 0.00;
                double totEprem = 0.00;
                for (int i = 0; i <= DtGridCorpaoratePol.Items.Count - 1; i++)
                {
                    totPprem = totPprem + double.Parse(DtGridCorpaoratePol.Items[i].Cells[7].Text);
                    totEprem = totEprem + double.Parse(DtGridCorpaoratePol.Items[i].Cells[8].Text);
                }

                //Aplicar Descuento corporativo.
                //Discount       
                if (txtDiscountP.Text.Trim() == "")
                    txtDiscountP.Text = "0";

                if (txtDiscount.Text.Trim() == "")
                    txtDiscount.Text = "0";

                double disc = 0.00;
                double totprem2 = 0.00;

                if (txtDiscountP.Text == "0")
                {
                    disc = double.Parse(txtDiscountP.Text.Replace("%", "").Trim());
                    totprem2 = totPprem;
                    txtTotalPrimaryPremium.Text = totprem2.ToString("###,###.00");
                }
                else
                {
                    disc = double.Parse(txtDiscountP.Text.Replace("%", "").Trim());
                    totprem2 = Math.Round((totPprem * (Math.Round(disc / 100, 2))), 0);
                    txtTotalPrimaryPremium.Text = totprem2.ToString("###,###.00");
                }

                if (txtDiscount.Text == "0")
                {
                    disc = double.Parse(txtDiscount.Text.Replace("%", "").Trim());
                    totprem2 = totEprem;
                    txtTotalExcessPremium.Text = totprem2.ToString("###,###.00");
                }
                else
                {
                    disc = double.Parse(txtDiscount.Text.Replace("%", "").Trim());
                    totprem2 = Math.Round((totEprem * (Math.Round(disc / 100, 2))), 0);
                    txtTotalExcessPremium.Text = totprem2.ToString("###,###.00");
                }

                this.Button2.Text = "Add";
                txtCustomerName2.Text = "";
                ddlPrimaryLimits1.SelectedIndex = -1;
                ddlLimits.SelectedIndex = -1;
                ddlPolicyClass.SelectedIndex = -1;
                txtIsoCode.Text = "";
                txtPRate4.Text = "";
                txtRate4.Text = "";

                ddlPolicyClass.Items.Clear();
                ddPrimarylPolicyClass.Items.Clear();

                Session["TaskControl"] = taskControl;
            }
            catch (Exception exp)
            {
                this.litPopUp.Text = Utilities.MakeLiteralPopUpString("Unable to save this Quote. " + exp.Message);
                this.litPopUp.Visible = true;
            }
        }

        protected void DtGridCorpaoratePol_ItemCommand(object source, DataGridCommandEventArgs e)
        {
            switch (e.CommandName)
            {
                case "Select": //Edit
                    this.Button2.Text = "Update";

                    //FillTextBox
                    txtCustomerName2.Text = e.Item.Cells[2].Text.ToString().Trim();
                    ddlPrimaryLimits1.SelectedIndex = ddlPrimaryLimits1.Items.IndexOf(ddlPrimaryLimits1.Items.FindByText(e.Item.Cells[3].Text.Trim()));
                    ddlLimits.SelectedIndex = ddlLimits.Items.IndexOf(ddlLimits.Items.FindByText(e.Item.Cells[4].Text.Trim()));

                    SetDDLLimit(int.Parse(ddlLimits.SelectedItem.Value), int.Parse(ddlPrimaryLimits1.SelectedItem.Value));

                    ddlPolicyClass.SelectedIndex = ddlPolicyClass.Items.IndexOf(ddlPolicyClass.Items.FindByText(e.Item.Cells[5].Text.Trim()));
                    txtIsoCode.Text = e.Item.Cells[6].Text.ToString().Trim();
                    txtPRate4.Text = e.Item.Cells[7].Text.ToString().Trim();
                    txtRate4.Text = e.Item.Cells[8].Text.ToString().Trim();
                    txtCorporatePolicyQuoteID.Text = e.Item.ItemIndex.ToString();

                    break;
                case "Delete":
                    DeleteCorporatePolicy(e.Item.ItemIndex);
                    break;
                default: //Page
                    if ((int.Parse(e.CommandArgument.ToString()) - 1) >= 0 &&
                        (int.Parse(e.CommandArgument.ToString()) - 1) <= this.DtGridCorpaoratePol.PageCount)
                    {
                        this.DtGridCorpaoratePol.CurrentPageIndex = int.Parse(e.CommandArgument.ToString()) - 1;
                        this.DtGridCorpaoratePol.DataSource = (DataTable)Session["DTCampaign"];
                        this.DtGridCorpaoratePol.DataBind();

                        this.DtGridCorpaoratePol.SelectedIndex = -1;
                    }
                    break;
            }
        }

        private void DeleteCorporatePolicy(int CorporatePolicyQuoteID)
        {
            try
            {
                EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

                DataTable dt = null;

                taskControl.CorporatePolicyDetailCollection.Rows.RemoveAt(CorporatePolicyQuoteID);
                taskControl.CorporatePolicyDetailCollection.AcceptChanges();
                dt = taskControl.CorporatePolicyDetailCollection;

                this.DtGridCorpaoratePol.CurrentPageIndex = 0;
                this.DtGridCorpaoratePol.Visible = true;
                this.DtGridCorpaoratePol.DataSource = dt;
                this.DtGridCorpaoratePol.DataBind();
                this.DtGridCorpaoratePol.Visible = true;
            }
            catch (Exception exp)
            {
                this.litPopUp.Text = Utilities.MakeLiteralPopUpString("Unable to save this Quote. " + exp.Message);
                this.litPopUp.Visible = true;
            }
        }

        protected void btnPrint_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            if (taskControl.IsPolicy)
            {
                if (taskControl.PolicyType.Trim() == "CP")
                {
                    if (taskControl.Anniversary == "01")
                    {
                        DataDynamics.ActiveReports.ActiveReport3 rpt = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt1 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt2 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt3 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt4 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt5 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt6 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt7 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt8 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt9 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt10 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt11 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt12 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt13 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt14 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt15 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt16 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt17 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt18 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt19 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt20 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt21 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt22 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt23 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt24 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt25 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt26 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt27 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt28 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt29 = null;

                        rpt3 = new EPolicy2.Reports.PRMdic.PrimaryPolicy();
                        rpt3.Document.Printer.PrinterName = "";
                        rpt3.Run(false);
                        rpt = rpt3;

                        rpt1 = new EPolicy2.Reports.PRMdic.PrimaryPolicy1((EPolicy.TaskControl.Policy)taskControl);
                        rpt1.Document.Printer.PrinterName = "";
                        rpt1.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt1.Document.Pages);

                        rpt2 = new EPolicy2.Reports.PRMdic.PrimaryPolicy2((EPolicy.TaskControl.Policy)taskControl);
                        rpt2.Document.Printer.PrinterName = "";
                        rpt2.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt2.Document.Pages);

                        rpt4 = new EPolicy2.Reports.PRMdic.PrimaryPolicy3();
                        rpt4.Document.Printer.PrinterName = "";
                        rpt4.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt4.Document.Pages);

                        rpt5 = new EPolicy2.Reports.PRMdic.PrimaryPolicy4();
                        rpt5.Document.Printer.PrinterName = "";
                        rpt5.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt5.Document.Pages);

                        rpt6 = new EPolicy2.Reports.PRMdic.PrimaryPolicy5();
                        rpt6.Document.Printer.PrinterName = "";
                        rpt6.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt6.Document.Pages);

                        rpt7 = new EPolicy2.Reports.PRMdic.PrimaryPolicy6();
                        rpt7.Document.Printer.PrinterName = "";
                        rpt7.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt7.Document.Pages);

                        rpt8 = new EPolicy2.Reports.PRMdic.PrimaryPolicy7();
                        rpt8.Document.Printer.PrinterName = "";
                        rpt8.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt8.Document.Pages);

                        rpt9 = new EPolicy2.Reports.PRMdic.PrimaryPolicy8();
                        rpt9.Document.Printer.PrinterName = "";
                        rpt9.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt9.Document.Pages);

                        rpt10 = new EPolicy2.Reports.PRMdic.PrimaryPolicy9();
                        rpt10.Document.Printer.PrinterName = "";
                        rpt10.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt10.Document.Pages);

                        rpt11 = new EPolicy2.Reports.PRMdic.PrimaryPolicy10();
                        rpt11.Document.Printer.PrinterName = "";
                        rpt11.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt11.Document.Pages);

                        rpt12 = new EPolicy2.Reports.PRMdic.PrimaryPolicy11();
                        rpt12.Document.Printer.PrinterName = "";
                        rpt12.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt12.Document.Pages);

                        rpt13 = new EPolicy2.Reports.PRMdic.PrimaryPolicy12();
                        rpt13.Document.Printer.PrinterName = "";
                        rpt13.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt13.Document.Pages);

                        rpt14 = new EPolicy2.Reports.PRMdic.PrimaryPolicy13();
                        rpt14.Document.Printer.PrinterName = "";
                        rpt14.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt14.Document.Pages);

                        rpt15 = new EPolicy2.Reports.PRMdic.PrimaryPolicy14();
                        rpt15.Document.Printer.PrinterName = "";
                        rpt15.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt15.Document.Pages);

                        rpt16 = new EPolicy2.Reports.PRMdic.PrimaryPolicy15();
                        rpt16.Document.Printer.PrinterName = "";
                        rpt16.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt16.Document.Pages);

                        rpt17 = new EPolicy2.Reports.PRMdic.PrimaryPolicy16((EPolicy.TaskControl.Policy)taskControl);
                        rpt17.Document.Printer.PrinterName = "";
                        rpt17.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt17.Document.Pages);

                        rpt18 = new EPolicy2.Reports.PRMdic.PrimarySchedulerEndorsement((EPolicy.TaskControl.Policy)taskControl);
                        rpt18.Document.Printer.PrinterName = "";
                        rpt18.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt18.Document.Pages);

                        rpt19 = new EPolicy2.Reports.PRMdic.PrimaryStatementAcceptance();
                        rpt19.Document.Printer.PrinterName = "";
                        rpt19.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt19.Document.Pages);

                        rpt20 = new EPolicy2.Reports.PRMdic.PrimaryMandatory1();
                        rpt20.Document.Printer.PrinterName = "";
                        rpt20.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt20.Document.Pages);

                        rpt21 = new EPolicy2.Reports.PRMdic.PrimaryMandatory2();
                        rpt21.Document.Printer.PrinterName = "";
                        rpt21.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt21.Document.Pages);

                        rpt22 = new EPolicy2.Reports.PRMdic.PrimaryMandatory3();
                        rpt22.Document.Printer.PrinterName = "";
                        rpt22.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt22.Document.Pages);

                        rpt23 = new EPolicy2.Reports.PRMdic.PrimaryContinuousRenewal();
                        rpt23.Document.Printer.PrinterName = "";
                        rpt23.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt23.Document.Pages);

                        rpt24 = new EPolicy2.Reports.PRMdic.PrimaryActOfWar();
                        rpt24.Document.Printer.PrinterName = "";
                        rpt24.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt24.Document.Pages);

                        rpt25 = new EPolicy2.Reports.PRMdic.PrimaryNuclearEnergy();
                        rpt25.Document.Printer.PrinterName = "";
                        rpt25.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt25.Document.Pages);

                        rpt26 = new EPolicy2.Reports.PRMdic.PrimaryNuclearEnergy2();
                        rpt26.Document.Printer.PrinterName = "";
                        rpt26.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt26.Document.Pages);

                        if (taskControl.EffectiveDate.Trim() != taskControl.RetroactiveDate.Trim())
                        {
                            rpt27 = new EPolicy2.Reports.PRMdic.PrimaryPriorAct((EPolicy.TaskControl.Policy)taskControl);
                            rpt27.Document.Printer.PrinterName = "";
                            rpt27.Run(false);
                            rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt27.Document.Pages);
                        }

                        if (TxtCharge.Text != ".00")
                        {
                            rpt29 = new EPolicy2.Reports.PRMdic.ChargeEng((EPolicy.TaskControl.Policy)taskControl);
                            rpt29.Document.Printer.PrinterName = "";
                            rpt29.Run(false);
                            rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt29.Document.Pages);
                        }

                        rpt28 = new EPolicy2.Reports.PRMdic.Invoice((EPolicy.TaskControl.Policy)taskControl, false);
                        rpt28.Document.Printer.PrinterName = "";
                        rpt28.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt28.Document.Pages);


                        RemoveSessionLookUp();
                        Session.Add("Report", rpt);
                        Session.Add("FromPage", "CorporatePolicyQuote.aspx");
                        Response.Redirect("ActiveXViewer.aspx");
                    }
                    else //Renovacion.
                    {
                        DataDynamics.ActiveReports.ActiveReport3 rpt = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt2 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt3 = null;

                        rpt = new EPolicy2.Reports.PRMdic.RenewalEndorsement((EPolicy.TaskControl.Policy)taskControl);
                        rpt.Document.Printer.PrinterName = "";
                        rpt.Run();

                        if (TxtCharge.Text != ".00")
                        {
                            rpt3 = new EPolicy2.Reports.PRMdic.ChargeEng((EPolicy.TaskControl.Policy)taskControl);
                            rpt3.Document.Printer.PrinterName = "";
                            rpt3.Run(false);
                            rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt3.Document.Pages);
                        }

                        rpt2 = new EPolicy2.Reports.PRMdic.Invoice(taskControl, false);
                        rpt2.Document.Printer.PrinterName = "";
                        rpt2.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt2.Document.Pages);

                        RemoveSessionLookUp();
                        Session.Add("Report", rpt);
                        Session.Add("FromPage", "CorporatePolicyQuote.aspx");
                        Response.Redirect("ActiveXViewer.aspx");
                    }
                }
                else //CE
                {
                    if (taskControl.Anniversary == "01")
                    {
                        DataDynamics.ActiveReports.ActiveReport3 rpt = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt1 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt2 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt3 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt4 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt5 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt6 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt7 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt8 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt9 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt10 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt11 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt12 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt13 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt14 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt15 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt16 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt17 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt18 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt19 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt20 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt21 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt22 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt23 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt24 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt25 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt26 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt27 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt28 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt29 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt30 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt31 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt32 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt33 = null;

                        rpt1 = new EPolicy2.Reports.PRMdic.Poliza();
                        rpt1.Document.Printer.PrinterName = "";
                        rpt1.Run();
                        rpt = rpt1;

                        rpt2 = new EPolicy2.Reports.PRMdic.Poliza1((EPolicy.TaskControl.Policy)taskControl);
                        rpt2.Document.Printer.PrinterName = "";
                        rpt2.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt2.Document.Pages);

                        rpt26 = new EPolicy2.Reports.PRMdic.Poliza2B((EPolicy.TaskControl.Policy)taskControl);
                        rpt26.Document.Printer.PrinterName = "";
                        rpt26.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt26.Document.Pages);

                        //rpt3 = new EPolicy2.Reports.PRMdic.Poliza2(taskControl);
                        //rpt3.Document.Printer.PrinterName = "";
                        //rpt3.Run(false);
                        //rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt3.Document.Pages);

                        rpt4 = new EPolicy2.Reports.PRMdic.Poliza3();
                        rpt4.Document.Printer.PrinterName = "";
                        rpt4.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt4.Document.Pages);

                        rpt5 = new EPolicy2.Reports.PRMdic.Poliza4();
                        rpt5.Document.Printer.PrinterName = "";
                        rpt5.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt5.Document.Pages);

                        rpt6 = new EPolicy2.Reports.PRMdic.Poliza5();
                        rpt6.Document.Printer.PrinterName = "";
                        rpt6.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt6.Document.Pages);

                        rpt7 = new EPolicy2.Reports.PRMdic.Poliza6();
                        rpt7.Document.Printer.PrinterName = "";
                        rpt7.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt7.Document.Pages);

                        rpt8 = new EPolicy2.Reports.PRMdic.Poliza7();
                        rpt8.Document.Printer.PrinterName = "";
                        rpt8.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt8.Document.Pages);

                        rpt9 = new EPolicy2.Reports.PRMdic.Poliza8();
                        rpt9.Document.Printer.PrinterName = "";
                        rpt9.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt9.Document.Pages);

                        rpt10 = new EPolicy2.Reports.PRMdic.Poliza9();
                        rpt10.Document.Printer.PrinterName = "";
                        rpt10.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt10.Document.Pages);

                        rpt11 = new EPolicy2.Reports.PRMdic.Poliza10();
                        rpt11.Document.Printer.PrinterName = "";
                        rpt11.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt11.Document.Pages);

                        rpt12 = new EPolicy2.Reports.PRMdic.Poliza11();
                        rpt12.Document.Printer.PrinterName = "";
                        rpt12.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt12.Document.Pages);

                        rpt13 = new EPolicy2.Reports.PRMdic.Poliza12();
                        rpt13.Document.Printer.PrinterName = "";
                        rpt13.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt13.Document.Pages);

                        rpt14 = new EPolicy2.Reports.PRMdic.Poliza13();
                        rpt14.Document.Printer.PrinterName = "";
                        rpt14.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt14.Document.Pages);

                        rpt15 = new EPolicy2.Reports.PRMdic.Poliza14();
                        rpt15.Document.Printer.PrinterName = "";
                        rpt15.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt15.Document.Pages);

                        rpt16 = new EPolicy2.Reports.PRMdic.Poliza15();
                        rpt16.Document.Printer.PrinterName = "";
                        rpt16.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt16.Document.Pages);

                        rpt17 = new EPolicy2.Reports.PRMdic.Poliza16();
                        rpt17.Document.Printer.PrinterName = "";
                        rpt17.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt17.Document.Pages);

                        rpt18 = new EPolicy2.Reports.PRMdic.Poliza17();
                        rpt18.Document.Printer.PrinterName = "";
                        rpt18.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt18.Document.Pages);

                        rpt19 = new EPolicy2.Reports.PRMdic.Poliza18();
                        rpt19.Document.Printer.PrinterName = "";
                        rpt19.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt19.Document.Pages);

                        rpt20 = new EPolicy2.Reports.PRMdic.Poliza19((EPolicy.TaskControl.Policy)taskControl);//
                        rpt20.Document.Printer.PrinterName = "";
                        rpt20.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt20.Document.Pages);

                        rpt30 = new EPolicy2.Reports.PRMdic.SchedulerEndorsement((EPolicy.TaskControl.Policy)taskControl); //Scheduler of Endorsement
                        rpt30.Document.Printer.PrinterName = "";
                        rpt30.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt30.Document.Pages);

                        rpt31 = new EPolicy2.Reports.PRMdic.StatementAcceptance();//StatementOfRepe.And Acceptance
                        rpt31.Document.Printer.PrinterName = "";
                        rpt31.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt31.Document.Pages);

                        rpt22 = new EPolicy2.Reports.PRMdic.ContinuousRenewal();
                        rpt22.Document.Printer.PrinterName = "";
                        rpt22.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt22.Document.Pages);

                        rpt23 = new EPolicy2.Reports.PRMdic.MandatoryPremium1();
                        rpt23.Document.Printer.PrinterName = "";
                        rpt23.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt23.Document.Pages);

                        rpt24 = new EPolicy2.Reports.PRMdic.MandatoryPremium2();
                        rpt24.Document.Printer.PrinterName = "";
                        rpt24.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt24.Document.Pages);

                        rpt25 = new EPolicy2.Reports.PRMdic.MandatoryPremium3();
                        rpt25.Document.Printer.PrinterName = "";
                        rpt25.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt25.Document.Pages);

                        rpt21 = new EPolicy2.Reports.PRMdic.ActOfWar();
                        rpt21.Document.Printer.PrinterName = "";
                        rpt21.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt21.Document.Pages);

                        rpt27 = new EPolicy2.Reports.PRMdic.NuclearEnergy();
                        rpt27.Document.Printer.PrinterName = "";
                        rpt27.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt27.Document.Pages);

                        rpt28 = new EPolicy2.Reports.PRMdic.NuclearEnergy2();
                        rpt28.Document.Printer.PrinterName = "";
                        rpt28.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt28.Document.Pages);

                        if (taskControl.EffectiveDate.Trim() != taskControl.RetroactiveDate.Trim())
                        {
                            rpt29 = new EPolicy2.Reports.PRMdic.PriorAct((EPolicy.TaskControl.Policy)taskControl);
                            rpt29.Document.Printer.PrinterName = "";
                            rpt29.Run(false);
                            rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt29.Document.Pages);
                        }

                        if (TxtCharge.Text != ".00")
                        {
                            rpt33 = new EPolicy2.Reports.PRMdic.ChargeEng((EPolicy.TaskControl.Policy)taskControl);
                            rpt33.Document.Printer.PrinterName = "";
                            rpt33.Run(false);
                            rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt33.Document.Pages);
                        }

                        rpt32 = new EPolicy2.Reports.PRMdic.Invoice(taskControl,false);
                        rpt32.Document.Printer.PrinterName = "";
                        rpt32.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt32.Document.Pages);

                        RemoveSessionLookUp();
                        Session.Add("Report", rpt);
                        Session.Add("FromPage", "CorporatePolicyQuote.aspx");
                        Response.Redirect("ActiveXViewer.aspx");
                    }
                    else //Renovacion.
                    {
                        DataDynamics.ActiveReports.ActiveReport3 rpt = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt2 = null;
                        DataDynamics.ActiveReports.ActiveReport3 rpt3 = null;

                        rpt = new EPolicy2.Reports.PRMdic.RenewalEndorsement((EPolicy.TaskControl.Policy)taskControl);
                        rpt.Document.Printer.PrinterName = "";
                        rpt.Run();

                        if (taskControl.EffectiveDate.Trim() != taskControl.RetroactiveDate.Trim())
                        {
                            rpt3 = new EPolicy2.Reports.PRMdic.PriorAct((EPolicy.TaskControl.Policy)taskControl);
                            rpt3.Document.Printer.PrinterName = "";
                            rpt3.Run(false);
                            rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt3.Document.Pages);
                        }

                        rpt2 = new EPolicy2.Reports.PRMdic.Invoice(taskControl,false);
                        rpt2.Document.Printer.PrinterName = "";
                        rpt2.Run(false);
                        rpt.Document.Pages.InsertRange(rpt.Document.Pages.Count, rpt2.Document.Pages);

                        RemoveSessionLookUp();
                        Session.Add("Report", rpt);
                        Session.Add("FromPage", "CorporatePolicyQuote.aspx");
                        Response.Redirect("ActiveXViewer.aspx");
                    }
                }
            }
            else
            {
                DataDynamics.ActiveReports.ActiveReport3 rpt = null;

                rpt = new EPolicy2.Reports.PRMdic.CorporateQuote(taskControl);
                rpt.Document.Printer.PrinterName = "";
                rpt.Run();

                RemoveSessionLookUp();
                Session.Add("Report", rpt);
                Session.Add("FromPage", "CorporatePolicyQuote.aspx");
                Response.Redirect("ActiveXViewer.aspx");
            }
        }
        protected void BtnSave_Click(object sender, EventArgs e)
        {
            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
            int userID = 0;

            try
            {
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
            }
            catch (Exception ex)
            {
                throw new Exception(
                    "Could not parse user id from cp.Identity.Name.", ex);
            }

            try
            {
                EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
                ValidateFields();
                FillProperties();

                taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

                taskControl.SaveCorporatePolicy(userID);  //(userID);

                if (taskControl.IsPolicy)
                {
                    //Update Inception Payment Amount
                    UpdateInceptionPartialPayments(taskControl.TaskControlID, taskControl.TotalPremium);
                }

                Session["TaskControl"] = taskControl;

                FillTextControl();
                DisableControls();

                this.litPopUp.Text = Utilities.MakeLiteralPopUpString("Quote Save Successfully.");
                this.litPopUp.Visible = true;
            }
            catch (Exception exp)
            {
                this.litPopUp.Text = Utilities.MakeLiteralPopUpString(exp.Message);
                this.litPopUp.Visible = true;
            }
        }

        private void ValidateFields()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            ArrayList errorMessages = new ArrayList();
            bool IsError = false;

            try
            {
                if (this.txtCorporation.Text == "")
                {
                    errorMessages.Add("The Corporate Field is missing." + "\r\n");
                    IsError = true;
                }

                if (this.txtTotalPrimaryPremium.Text.Trim() == "" || double.Parse(this.txtTotalPrimaryPremium.Text.Trim()) == 0)
                {
                    errorMessages.Add("You have to add at least at Physician to list." + "\r\n");
                }

                if (this.txtTotalPrimaryCorporate.Text.Trim() == "" || double.Parse(this.txtTotalPrimaryCorporate.Text.Trim()) == 0)
                {
                    errorMessages.Add("Yor have to calculate or Verify the fileds. " + "\r\n");
                }

                if (taskControl.IsPolicy)
                {
                    if (ddlAgency.SelectedItem.Value.Trim() == "")
                        errorMessages.Add("Please choose a agency." + "\r\n");

                    if (ddlAgency.SelectedItem.Value.Trim() == "000")
                        errorMessages.Add("Please choose a agency." + "\r\n");
                }

                if (errorMessages.Count > 0)
                {
                    string popUpString = "";

                    foreach (string message in errorMessages)
                    {
                        popUpString += message + " ";
                    }

                    throw new Exception(popUpString);
                }
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }

        protected void btnEdit_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            FillTextControl();
            taskControl.Mode = (int)EPolicy.TaskControl.TaskControl.TaskControlMode.UPDATE;

            Session.Add("TaskControl", taskControl);
            EnableControls();
        }
        protected void btnAddNew_Click(object sender, EventArgs e)
        {
            Session.Clear();
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = new EPolicy.TaskControl.CorporatePolicyQuote(true);

            taskControl.Mode = 1; //ADD

            Session.Add("TaskControl", taskControl);

            Response.Redirect("CorporatePolicyQuote.aspx", false);
        }

        protected void cmdCancel_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
            int userID = 0;

            try
            {
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
            }
            catch (Exception ex)
            {
                throw new Exception(
                    "Could not parse user id from cp.Identity.Name.", ex);
            }

            if (taskControl.TaskControlID == 0) //ADD
            {
                Session.Clear();
                Response.Redirect("MainMenu.aspx");
            }
            else
            {
                taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)EPolicy.TaskControl.TaskControl.GetTaskControlByTaskControlID(taskControl.TaskControlID, userID);
                taskControl.Mode = (int)EPolicy.TaskControl.TaskControl.TaskControlMode.CLEAR;
                Session["TaskControl"] = taskControl;
                FillTextControl();
                DisableControls();
            }
        }
        protected void BtnExit_Click(object sender, EventArgs e)
        {
            RemoveSessionLookUp();
            this.litPopUp.Visible = false;
            Session.Clear();
            Response.Redirect("MainMenu.aspx");
        }

        private void RemoveSessionLookUp()
        {
            Session.Remove("LookUpTables");
        }

        protected void ddlCorparation_SelectedIndexChanged(object sender, EventArgs e)
        {

        }
        protected void ddlPrimaryLimits1_SelectedIndexChanged(object sender, EventArgs e)
        {
            SetAllRate();
        }
        protected void ddlLimits_SelectedIndexChanged(object sender, EventArgs e)
        {
            SetAllRate();
        }

        private void SetAllRate()
        {
            try
            {

                GetAllRates();
            }
            catch (Exception ex)
            {
                this.litPopUp.Text = EPolicy.Utilities.MakeLiteralPopUpString(ex.Message);
                this.litPopUp.Visible = true;
            }
        }

        private void GetAllRates()
        {
            int limit = 0;
            if (ddlLimits.SelectedItem.Value.Trim() == "")
                limit = 0;
            else
                limit = int.Parse(ddlLimits.SelectedItem.Value);

            int primaryLimit = 0;
            if (ddlPrimaryLimits1.SelectedItem.Value.Trim() == "")
                primaryLimit = 0;
            else
                primaryLimit = int.Parse(ddlPrimaryLimits1.SelectedItem.Value);

            this.txtPRate4.Text = "";
            this.txtIsoCode.Text = "";
            this.txtRate4.Text = "";

            txtPrimaryTN1.Text = "";
            txtPrimaryTN2.Text = "";
            txtPrimaryTN3.Text = "";
            txtPrimaryTN4.Text = "";
            txtPrimaryTN5.Text = "";
            txtPremiumTN1.Text = "";
            txtPremiumTN2.Text = "";
            txtPremiumTN3.Text = "";
            txtPremiumTN4.Text = "";
            txtPremiumTN5.Text = "";
            txtQuantityTN1.Text = "";
            txtQuantityTN2.Text = "";
            txtQuantityTN3.Text = "";
            txtQuantityTN4.Text = "";
            txtQuantityTN5.Text = "";
            txtQuantityTN6.Text = "";
            txtTotPremTN1.Text = "";
            txtTotPremTN2.Text = "";
            txtTotPremTN3.Text = "";
            txtTotPremTN4.Text = "";
            txtTotPremTN5.Text = "";
            txtTotPremTN6.Text = "";

            txtExcessTN1.Text = "";
            txtExcessTN2.Text = "";
            txtExcessTN3.Text = "";
            txtExcessTN4.Text = "";
            txtExcessTN5.Text = "";
            txtEPremiumTN1.Text = "";
            txtEPremiumTN2.Text = "";
            txtEPremiumTN3.Text = "";
            txtEPremiumTN4.Text = "";
            txtEPremiumTN5.Text = "";
            txtEQuantityTN1.Text = "";
            txtEQuantityTN2.Text = "";
            txtEQuantityTN3.Text = "";
            txtEQuantityTN4.Text = "";
            txtEQuantityTN5.Text = "";
            txtEQuantityTN6.Text = "";
            txtETotPremTN1.Text = "";
            txtETotPremTN2.Text = "";
            txtETotPremTN3.Text = "";
            txtETotPremTN4.Text = "";
            txtETotPremTN5.Text = "";
            txtETotPremTN6.Text = "";

            txtTotalPrimaryCorporate.Text = "";
            txtTotalExcessCorporate.Text = "";

            //Primary
            this.txtPRate4.Text = "";

            SetDDLLimit(limit, primaryLimit);
        }

        protected void ddlPolicyClass_SelectedIndexChanged1(object sender, EventArgs e)
        {
            //SetddlPimaryPolicyClass
            ddPrimarylPolicyClass.SelectedIndex = ddPrimarylPolicyClass.Items.IndexOf(
                ddPrimarylPolicyClass.Items.FindByText(this.ddlPolicyClass.SelectedItem.Text.Trim()));

            string myStringPrimary = this.ddPrimarylPolicyClass.SelectedValue.Trim();
            string[] myPrimaryRateList = myStringPrimary.Split('|');

            this.HIPrimeryRateID.Value = myPrimaryRateList[0];

            string myString = this.ddlPolicyClass.SelectedValue.Trim();
            string[] myRateList = myString.Split('|');

            this.txtPrateID.Value = myRateList[0];
            this.txtIsoCode.Text = myRateList[1];
            this.txtRate4.Text = int.Parse(myRateList[6]).ToString("###,###,###.00");

            DataTable dtPRMEDICRATE2 = EPolicy.TaskControl.Application.GetPRMEDICRATEBYISOCODE(int.Parse(txtPrateID.Value), txtIsoCode.Text.Trim());

            if (dtPRMEDICRATE2.Rows.Count > 0)
            {
                int index = 1;
                for (int i = 0; dtPRMEDICRATE2.Rows.Count > i; i++)
                {
                    myString = dtPRMEDICRATE2.Rows[i]["PRMEDICRATEID"].ToString().Trim();
                    myRateList = myString.Split('|');

                    if (int.Parse(txtPrateID.Value.Trim()) != int.Parse(myRateList[0].Trim()))
                    {
                        //SetOtherRateFields(index, myRateList);
                        index = index + 1;
                    }
                }
            }

            //Primary
            DataTable dtPRMEDICRATEPRIMARY2 = EPolicy.TaskControl.Application.GetPRMEDICRATEPRIMARYBYISOCODE(int.Parse(HIPrimeryRateID.Value), txtIsoCode.Text.Trim());
            if (dtPRMEDICRATEPRIMARY2.Rows.Count > 0)
            {
                int index = 1;
                for (int i = 0; dtPRMEDICRATEPRIMARY2.Rows.Count > i; i++)
                {
                    myString = dtPRMEDICRATEPRIMARY2.Rows[i]["PRMEDICRATEID"].ToString().Trim();
                    myRateList = myString.Split('|');

                    if (int.Parse(myRateList[0].Trim()) != 0)
                    {
                        SetPrimaryRates(index, myRateList);
                        index = index + 1;
                    }
                }
            }

            GetOthersRates();
        }

        private void GetOthersRates()
        {
            //Primary
            DataTable dt1 = TaskControl.CorporatePolicyQuote.GetPRMEDICRATEPRIMARYByClassAndLimitID("1", int.Parse(ddlPrimaryLimits1.SelectedItem.Value.Trim()));
            DataTable dt2 = TaskControl.CorporatePolicyQuote.GetPRMEDICRATEPRIMARYByClassAndLimitID("7", int.Parse(ddlPrimaryLimits1.SelectedItem.Value.Trim()));
            DataTable dt3 = TaskControl.CorporatePolicyQuote.GetPRMEDICRATEPRIMARYByClassAndLimitID("3A", int.Parse(ddlPrimaryLimits1.SelectedItem.Value.Trim()));

            txtPrimaryTN1.Text = (double.Parse(dt1.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtPrimaryTN2.Text = (double.Parse(dt2.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtPrimaryTN3.Text = (double.Parse(dt3.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtPrimaryTN4.Text = (double.Parse(dt1.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtPrimaryTN5.Text = (double.Parse(dt1.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");


            //Excess
            DataTable dt4 = TaskControl.CorporatePolicyQuote.GetPRMEDICRATEByClassAndLimitID("1", int.Parse(ddlLimits.SelectedItem.Value.Trim()));
            DataTable dt5 = TaskControl.CorporatePolicyQuote.GetPRMEDICRATEByClassAndLimitID("7", int.Parse(ddlLimits.SelectedItem.Value.Trim()));
            DataTable dt6 = TaskControl.CorporatePolicyQuote.GetPRMEDICRATEByClassAndLimitID("3A", int.Parse(ddlLimits.SelectedItem.Value.Trim()));

            txtExcessTN1.Text = (double.Parse(dt4.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtExcessTN2.Text = (double.Parse(dt5.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtExcessTN3.Text = (double.Parse(dt6.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtExcessTN4.Text = (double.Parse(dt4.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");
            txtExcessTN5.Text = (double.Parse(dt4.Rows[0]["MCMRate"].ToString())).ToString("###,###.00");

            CalculateOthersRates();
        }

        private void CalculateOthersRates()
        {
            //Primary
            if (txtRateTN1.Text.Trim() == "")
                txtRateTN1.Text = "0";
            if (txtRateTN2.Text.Trim() == "")
                txtRateTN2.Text = "0";
            if (txtRateTN3.Text.Trim() == "")
                txtRateTN3.Text = "0";
            if (txtRateTN4.Text.Trim() == "")
                txtRateTN4.Text = "0";
            if (txtRateTN5.Text.Trim() == "")
                txtRateTN5.Text = "0";
            if (txtRateTN6.Text.Trim() == "")
                txtRateTN6.Text = "0";

            double P1 = Math.Round(double.Parse(txtPrimaryTN1.Text) * (double.Parse(txtRateTN1.Text.Replace("%", "")) / 100), 0);
            double P2 = Math.Round(double.Parse(txtPrimaryTN2.Text) * (double.Parse(txtRateTN2.Text.Replace("%", "")) / 100), 0);
            double P3 = Math.Round(double.Parse(txtPrimaryTN3.Text) * (double.Parse(txtRateTN3.Text.Replace("%", "")) / 100), 0);
            double P4 = Math.Round(double.Parse(txtPrimaryTN4.Text) * (double.Parse(txtRateTN4.Text.Replace("%", "")) / 100), 0);
            double P5 = Math.Round(double.Parse(txtPrimaryTN5.Text) * (double.Parse(txtRateTN5.Text.Replace("%", "")) / 100), 0);

            txtPremiumTN1.Text = P1.ToString("###,###.00");
            txtPremiumTN2.Text = P2.ToString("###,###.00");
            txtPremiumTN3.Text = P3.ToString("###,###.00");
            txtPremiumTN4.Text = P4.ToString("###,###.00");
            txtPremiumTN5.Text = P5.ToString("###,###.00");

            //Excess
            if (txtERateTN1.Text.Trim() == "")
                txtERateTN1.Text = "0";
            if (txtERateTN2.Text.Trim() == "")
                txtERateTN2.Text = "0";
            if (txtERateTN3.Text.Trim() == "")
                txtERateTN3.Text = "0";
            if (txtERateTN4.Text.Trim() == "")
                txtERateTN4.Text = "0";
            if (txtERateTN5.Text.Trim() == "")
                txtERateTN5.Text = "0";
            if (txtERateTN6.Text.Trim() == "")
                txtERateTN6.Text = "0";

            double E1 = Math.Round(double.Parse(txtExcessTN1.Text) * (double.Parse(txtERateTN1.Text.Replace("%", "")) / 100), 0);
            double E2 = Math.Round(double.Parse(txtExcessTN2.Text) * (double.Parse(txtERateTN2.Text.Replace("%", "")) / 100), 0);
            double E3 = Math.Round(double.Parse(txtExcessTN3.Text) * (double.Parse(txtERateTN3.Text.Replace("%", "")) / 100), 0);
            double E4 = Math.Round(double.Parse(txtExcessTN4.Text) * (double.Parse(txtERateTN4.Text.Replace("%", "")) / 100), 0);
            double E5 = Math.Round(double.Parse(txtExcessTN5.Text) * (double.Parse(txtERateTN5.Text.Replace("%", "")) / 100), 0);

            txtEPremiumTN1.Text = E1.ToString("###,###.00");
            txtEPremiumTN2.Text = E2.ToString("###,###.00");
            txtEPremiumTN3.Text = E3.ToString("###,###.00");
            txtEPremiumTN4.Text = E4.ToString("###,###.00");
            txtEPremiumTN5.Text = E5.ToString("###,###.00");
        }

        private void SetPrimaryRates(int index, string[] myRateList)
        {
            if (index == 1)
            {
                ddlPrimaryLimits1.SelectedIndex = ddlPrimaryLimits1.Items.IndexOf(
                        ddlPrimaryLimits1.Items.FindByValue(myRateList[7].ToString()));

                this.txtPRate4.Text = int.Parse(myRateList[6]).ToString("###,###,###.00");
            }
        }

        private void SetDDLLimit(int LimitID, int primaryLimit)
        {
            //Excess
            DataTable dtPRMEDICRATE1 = EPolicy.TaskControl.Application.GetPRMEDICRATE(LimitID);
            ddlPolicyClass.Items.Clear();
            ddlPolicyClass.DataSource = dtPRMEDICRATE1;
            ddlPolicyClass.DataTextField = "PRMEDICRATEDesc";
            ddlPolicyClass.DataValueField = "PRMEDICRATEID";
            ddlPolicyClass.DataBind();
            ddlPolicyClass.SelectedIndex = -1;
            ddlPolicyClass.Items.Insert(0, "");

            //Primary
            DataTable dtPRMEDICRATE2 = EPolicy.TaskControl.Application.GetPRMEDICPrimaryRATE(primaryLimit);
            ddPrimarylPolicyClass.Items.Clear();
            ddPrimarylPolicyClass.DataSource = dtPRMEDICRATE2;
            ddPrimarylPolicyClass.DataTextField = "PRMEDICRATEDesc";
            ddPrimarylPolicyClass.DataValueField = "PRMEDICRATEID";
            ddPrimarylPolicyClass.DataBind();
            ddPrimarylPolicyClass.SelectedIndex = -1;
            ddPrimarylPolicyClass.Items.Insert(0, "");
        }

        protected void Button3_Click(object sender, EventArgs e)
        {
            Calculate();
        }

        private void Calculate()
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            CalculateOthersRates();

            if (txtTotalPrimaryPremium.Text.Trim() == "")
                txtTotalPrimaryPremium.Text = "0";

            if (txtTotalExcessPremium.Text.Trim() == "")
                txtTotalExcessPremium.Text = "0";

            if (txtQuantityTN1.Text.Trim() == "")
                txtQuantityTN1.Text = "0";

            if (txtQuantityTN2.Text.Trim() == "")
                txtQuantityTN2.Text = "0";

            if (txtQuantityTN3.Text.Trim() == "")
                txtQuantityTN3.Text = "0";

            if (txtQuantityTN4.Text.Trim() == "")
                txtQuantityTN4.Text = "0";

            if (txtQuantityTN5.Text.Trim() == "")
                txtQuantityTN5.Text = "0";

            if (txtQuantityTN6.Text.Trim() == "")
                txtQuantityTN6.Text = "0";

            if (txtEQuantityTN1.Text.Trim() == "")
                txtEQuantityTN1.Text = "0";

            if (txtEQuantityTN2.Text.Trim() == "")
                txtEQuantityTN2.Text = "0";

            if (txtEQuantityTN3.Text.Trim() == "")
                txtEQuantityTN3.Text = "0";

            if (txtEQuantityTN4.Text.Trim() == "")
                txtEQuantityTN4.Text = "0";

            if (txtEQuantityTN5.Text.Trim() == "")
                txtEQuantityTN5.Text = "0";

            if (txtEQuantityTN6.Text.Trim() == "")
                txtEQuantityTN6.Text = "0";

            //Primary
            int quantity1 = int.Parse(txtQuantityTN1.Text.Trim());
            int quantity2 = int.Parse(txtQuantityTN2.Text.Trim());
            int quantity3 = int.Parse(txtQuantityTN3.Text.Trim());
            int quantity4 = int.Parse(txtQuantityTN4.Text.Trim());
            int quantity5 = int.Parse(txtQuantityTN5.Text.Trim());
            int quantity6 = quantity1 + quantity2 + quantity3 + quantity4 + quantity5;
            txtQuantityTN6.Text = quantity6.ToString();

            int tot1 = int.Parse(txtPremiumTN1.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtQuantityTN1.Text);
            txtTotPremTN1.Text = tot1.ToString("###,###,###.00");

            int tot2 = int.Parse(txtPremiumTN2.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtQuantityTN2.Text);
            txtTotPremTN2.Text = tot2.ToString("###,###,###.00");

            int tot3 = int.Parse(txtPremiumTN3.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtQuantityTN3.Text);
            txtTotPremTN3.Text = tot3.ToString("###,###,###.00");

            int tot4 = int.Parse(txtPremiumTN4.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtQuantityTN4.Text);
            txtTotPremTN4.Text = tot4.ToString("###,###,###.00");

            int tot5 = int.Parse(txtPremiumTN5.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtQuantityTN5.Text);
            txtTotPremTN5.Text = tot5.ToString("###,###,###.00");

            int tot6 = tot1 + tot2 + tot3 + tot4 + tot5;
            double P1 = Math.Round(double.Parse(tot6.ToString()) * (double.Parse(txtRateTN6.Text.Replace("%", "")) / 100), 0);
            txtTotPremTN6.Text = P1.ToString("###,###,###.00");

            //Excess
            int Equantity1 = int.Parse(txtEQuantityTN1.Text.Trim());
            int Equantity2 = int.Parse(txtEQuantityTN2.Text.Trim());
            int Equantity3 = int.Parse(txtEQuantityTN3.Text.Trim());
            int Equantity4 = int.Parse(txtEQuantityTN4.Text.Trim());
            int Equantity5 = int.Parse(txtEQuantityTN5.Text.Trim());
            int Equantity6 = Equantity1 + Equantity2 + Equantity3 + Equantity4 + Equantity5;
            txtEQuantityTN6.Text = Equantity6.ToString();

            int tot10 = int.Parse(txtEPremiumTN1.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtEQuantityTN1.Text);
            txtETotPremTN1.Text = tot10.ToString("###,###,###.00");

            int tot20 = int.Parse(txtEPremiumTN2.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtEQuantityTN2.Text);
            txtETotPremTN2.Text = tot20.ToString("###,###,###.00");

            int tot30 = int.Parse(txtEPremiumTN3.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtEQuantityTN3.Text);
            txtETotPremTN3.Text = tot30.ToString("###,###,###.00");

            int tot40 = int.Parse(txtEPremiumTN4.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtEQuantityTN4.Text);
            txtETotPremTN4.Text = tot40.ToString("###,###,###.00");

            int tot50 = int.Parse(txtEPremiumTN5.Text.Replace(".00", "").Replace(",", "")) * int.Parse(txtEQuantityTN5.Text);
            txtETotPremTN5.Text = tot50.ToString("###,###,###.00");

            int tot60 = tot10 + tot20 + tot30 + tot40 + tot50;
            double P2 = Math.Round(double.Parse(tot60.ToString()) * (double.Parse(txtERateTN6.Text.Replace("%", "")) / 100), 0);
            txtETotPremTN6.Text = P2.ToString("###,###,###.00");

            int totPrimaryPremium = int.Parse(txtTotalPrimaryPremium.Text.Trim().Replace(".00", "").Replace(",", "")) + int.Parse(P1.ToString());
            txtTotalPrimaryCorporate.Text = totPrimaryPremium.ToString("###,###,###.00");

            int totExcessPremium = int.Parse(txtTotalExcessPremium.Text.Trim().Replace(".00", "").Replace(",", "")) + int.Parse(P2.ToString());
            txtTotalExcessCorporate.Text = totExcessPremium.ToString("###,###,###.00");

            if (taskControl.IsPolicy)
            {
                if (taskControl.PolicyType.Trim() == "CP")
                    TxtTotalPremium.Text = totPrimaryPremium.ToString("###,###,###.00");
                else
                    TxtTotalPremium.Text = totExcessPremium.ToString("###,###,###.00");
            }
        }
        protected void btnConvertPrimary_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControlQuote = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = new EPolicy.TaskControl.CorporatePolicyQuote(true);

            taskControl = taskControlQuote;
            taskControl.Mode = 1; //ADD
            taskControl.PolicyClassID = 15;
            taskControl.TaskControlTypeID = 18;
            taskControl.IsPolicy = true;
            taskControl.Agency = taskControlQuote.Agency;
            taskControl.Agent = taskControlQuote.Agent;
            taskControl.AutoAssignPolicy = false;
            taskControl.InsuranceCompany = "001";
            taskControl.OriginatedAt = 1;
            taskControl.Term = 12;

            taskControl.TaskControlID = 0;
            taskControl.Customer.ProspectID = taskControlQuote.Prospect.ProspectID;
            taskControl.Customer.CustomerNo = taskControlQuote.Customer.CustomerNo;
            taskControl.Customer.FirstName = taskControlQuote.Customer.FirstName;
            taskControl.Customer.Initial = taskControlQuote.Customer.Initial;
            taskControl.Customer.LastName1 = taskControlQuote.Customer.LastName1;
            taskControl.Customer.LastName2 = taskControlQuote.Customer.LastName2;
            taskControl.Customer.Description = taskControlQuote.Customer.Description;
            taskControl.Customer.Sex = taskControlQuote.Customer.Sex;
            taskControl.Customer.Address1 = taskControlQuote.Customer.Address1;
            taskControl.Customer.Address2 = taskControlQuote.Customer.Address2;
            taskControl.Customer.City = taskControlQuote.Customer.City;
            taskControl.Customer.State = taskControlQuote.Customer.State;
            taskControl.Customer.ZipCode = taskControlQuote.Customer.ZipCode;
            taskControl.Customer.HomePhone = taskControlQuote.Customer.HomePhone;
            taskControl.Customer.JobPhone = taskControlQuote.Customer.JobPhone;
            taskControl.Customer.Cellular = taskControlQuote.Customer.Cellular;
            taskControl.Customer.Email = taskControlQuote.Customer.Email;
            taskControl.Customer.License = taskControlQuote.Customer.License;

            taskControl.PolicyType = "CP";
            taskControl.TotalPremium = taskControlQuote.TotalPrimaryCorporate;

            Session.Clear();
            Session.Add("TaskControl", taskControl);
            Response.Redirect("CorporatePolicyQuote.aspx", true);
        }
        protected void btnConvert_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.CorporatePolicyQuote taskControlQuote = (EPolicy.TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            EPolicy.TaskControl.CorporatePolicyQuote taskControl = new EPolicy.TaskControl.CorporatePolicyQuote(true);

            taskControl = taskControlQuote;
            taskControl.Mode = 1; //ADD
            taskControl.PolicyClassID = 15;
            taskControl.TaskControlTypeID = 18;
            taskControl.IsPolicy = true;
            taskControl.Agency = taskControlQuote.Agency;
            taskControl.Agent = taskControlQuote.Agent;
            taskControl.AutoAssignPolicy = false;
            taskControl.InsuranceCompany = "001";
            taskControl.OriginatedAt = 1;
            taskControl.Term = 12;

            taskControl.TaskControlID = 0;
            taskControl.Customer.ProspectID = taskControlQuote.Prospect.ProspectID;
            taskControl.Customer.CustomerNo = taskControlQuote.Customer.CustomerNo;
            taskControl.Customer.FirstName = taskControlQuote.Customer.FirstName;
            taskControl.Customer.Initial = taskControlQuote.Customer.Initial;
            taskControl.Customer.LastName1 = taskControlQuote.Customer.LastName1;
            taskControl.Customer.LastName2 = taskControlQuote.Customer.LastName2;
            taskControl.Customer.Description = taskControlQuote.Customer.Description;
            taskControl.Customer.Sex = taskControlQuote.Customer.Sex;
            taskControl.Customer.Address1 = taskControlQuote.Customer.Address1;
            taskControl.Customer.Address2 = taskControlQuote.Customer.Address2;
            taskControl.Customer.City = taskControlQuote.Customer.City;
            taskControl.Customer.State = taskControlQuote.Customer.State;
            taskControl.Customer.ZipCode = taskControlQuote.Customer.ZipCode;
            taskControl.Customer.HomePhone = taskControlQuote.Customer.HomePhone;
            taskControl.Customer.JobPhone = taskControlQuote.Customer.JobPhone;
            taskControl.Customer.Cellular = taskControlQuote.Customer.Cellular;
            taskControl.Customer.Email = taskControlQuote.Customer.Email;
            taskControl.Customer.License = taskControlQuote.Customer.License;

            taskControl.PolicyType = "CE";
            taskControl.TotalPremium = taskControlQuote.TotalExcessCorporate;

            Session.Clear();
            Session.Add("TaskControl", taskControl);
            Response.Redirect("CorporatePolicyQuote.aspx", true);
        }

        protected void btnRenew_Click(object sender, EventArgs e)
        {
            TaskControl.CorporatePolicyQuote taskControl = (TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            TaskControl.Policy policy = (TaskControl.Policy)Session["TaskControl"];
            TaskControl.CorporatePolicyQuote policies = new TaskControl.CorporatePolicyQuote(true);

            try
            {
                policies = taskControl;
                policies.Corporate = taskControl.Corporate;
                policies.CorporatePolicyDetailCollection = taskControl.CorporatePolicyDetailCollection;
                policies.Mode = 1;
                policies.CancellationDate = "";
                policies.CancellationEntryDate = "";
                policies.CancellationUnearnedPercent = 0.00;
                policies.CancellationMethod = 0;
                policies.CancellationReason = 0;
                policies.PaidAmount = 0.00; // taskControl.PaidAmount;
                policies.PaidDate = "";
                policies.Ren_Rei = "RN";
                policies.Rein_Amt = taskControl.CancellationAmount;
                policies.PaidDate = taskControl.PaidDate;
                policies.CommissionAgency = 0.00; // taskControl.ReturnCommissionAgency;
                policies.CommissionAgent = 0.00; // taskControl.ReturnCommissionAgent;
                policies.CommissionAgencyPercent = ""; // taskControl.CommissionAgencyPercent.Trim();
                policies.CommissionAgentPercent = "";  //taskControl.CommissionAgentPercent.Trim();
                policies.TaskControlID = 0;
                policies.Status = "Inforce";

                policies.EntryDate = DateTime.Now;
                policies.EffectiveDate = (DateTime.Parse(policies.EffectiveDate).AddMonths(12)).ToShortDateString();
                policies.ExpirationDate = DateTime.Parse(policies.ExpirationDate).AddMonths(12).ToShortDateString();

                policies.Charge = taskControl.Charge;
                policies.ReturnCharge = 0.00;
                policies.ReturnPremium = 0.00;
                policies.CancellationAmount = 0.00;
                policies.ReturnCommissionAgency = 0.00;
                policies.ReturnCommissionAgent = 0.00;

                int msufijo;
                int sufijo = int.Parse(taskControl.Suffix);
                msufijo = sufijo + 1;
                policies.Suffix = "0".ToString() + msufijo.ToString();

                int mAniv;
                int aniv = int.Parse(taskControl.Anniversary);
                mAniv = aniv + 1;
                policies.Anniversary = "0".ToString() + mAniv.ToString();

                Session.Clear();
                Session.Add("TaskControl", policies);
                Response.Redirect("CorporatePolicyQuote.aspx", false);
            }
            catch (Exception exp)
            {
                this.litPopUp.Text = Utilities.MakeLiteralPopUpString(exp.Message);
                this.litPopUp.Visible = true;
            }
        }
        protected void ChkAutoAssignPolicy_CheckedChanged(object sender, EventArgs e)
        {
            VerifyAssignPolicyFields();
        }
        private void VerifyAssignPolicyFields()
        {
            if (this.ChkAutoAssignPolicy.Checked)
            {
                TxtPolicyType.Enabled = false;
                TxtPolicyNo.Enabled = false;
                TxtCertificate.Enabled = false;
                TxtSufijo.Enabled = false;
            }
            else
            {
                TxtPolicyType.Enabled = true;
                TxtPolicyNo.Enabled = true;
                TxtCertificate.Enabled = true;
                TxtSufijo.Enabled = true;
            }
        }
        protected void ddlCiudad_SelectedIndexChanged(object sender, EventArgs e)
        {

        }

        private void SetddlSelectedAgent(DataTable dt)
        {
            ddlSelectedAgent.Items.Clear();

            for (int i = 0; i < dt.Rows.Count; i++)
            {
                ddlSelectedAgent.Items.Add(dt.Rows[i]["CommissionLevel"].ToString().Trim() +
                    " |" + dt.Rows[i]["AgentDesc"].ToString().Trim());
                ddlSelectedAgent.Items[i].Value = dt.Rows[i]["CommissionLevel"].ToString().Trim() +
                    " |" + dt.Rows[i]["AgentID"].ToString();
            }
        }

        private void ddlSelectedAgentOrder()
        {
            ListItemCollection lst = (ListItemCollection)ddlSelectedAgent.Items;

            for (int i = 0; i < lst.Count; i++)
            {
                for (int a = 0; a < lst.Count - 1; a++)
                {
                    int order = int.Parse(lst[a].Text.Split("|".ToCharArray())[0]);
                    if (order == i + 1)
                    {
                        ListItem list = new ListItem(lst[a].Text, lst[a].Value);
                        ddlSelectedAgent.Items.Add(list);
                        ddlSelectedAgent.Items.Remove(lst[a]);

                        a = lst.Count - 1;
                    }
                }
            }
            lst = null;
        }

        private void VerifyLabelAgent(int level, int CurrentLevel, bool firstTime)
        {
            // Se le Aade uno para visualizar el prximo nivel a seleccionarse 
            // Posiciona el nivel dependiendo el orden de los agentes seleccionados.

            if (CurrentLevel != 0)
            {
                level = CurrentLevel;
            }
            else
            {
                if (level != 0)
                {
                    level = level + 1;
                }
            }

            if (level != 0)
            {
                //LblSelectAgent.Text = "Available Agent - Level " + level.ToString().Trim();
            }
            else
            {
                if (firstTime)
                {
                    level = 1;
                    //LblSelectAgent.Text = "Available Agent - Level 1";
                }
                else
                {
                    //LblSelectAgent.Text = "Available Agent - Level ";
                }
            }

            //Actulizo el DropdownList con los agentes del nivel para seleccionarse. - ddlAvailableAgent.
            TaskControl.CorporatePolicyQuote taskControl = (TaskControl.CorporatePolicyQuote)Session["TaskControl"];

            DataTable dtAvail = taskControl.AgentList;
            DataTable dt = dtAvail.Clone();
            DataRow[] DrAvail = dtAvail.Select("AgentLevel = " + level, "AgentDesc");

            for (int i = 0; i <= DrAvail.Length - 1; i++)
            {
                DataRow myRow = dt.NewRow();
                myRow["AgentID"] = DrAvail[i].ItemArray[0].ToString();
                myRow["AgentDesc"] = DrAvail[i].ItemArray[1].ToString();
                myRow["AgentLevel"] = (int)DrAvail[i].ItemArray[2];

                dt.Rows.Add(myRow);
                dt.AcceptChanges();
            }

            SetddlAvailableAgent(dt);

            if (ddlAvailableAgent.Items.Count == 0)
            {
                //LblSelectAgent.Text = "Available Agent - Level ";
            }
        }
        private void SetddlAvailableAgent(DataTable dt)
        {
            ddlAvailableAgent.Items.Clear();

            for (int i = 0; i < dt.Rows.Count; i++)
            {
                ddlAvailableAgent.Items.Add(dt.Rows[i]["AgentLevel"].ToString().Trim() +
                    " |" + dt.Rows[i]["AgentDesc"].ToString().Trim());
                ddlAvailableAgent.Items[i].Value = dt.Rows[i]["AgentLevel"].ToString().Trim() +
                    " |" + dt.Rows[i]["AgentID"].ToString().Trim();
            }
        }
        protected void btnPayments_Click(object sender, EventArgs e)
        {
            RemoveSessionLookUp();
            Session.Add("FromPage", "CorporatePolicyQuote.aspx");
            Response.Redirect("ViewPayment.aspx");
        }

        private void UpdateInceptionPartialPayments(int taskControlID, double totprem)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            decimal prem = decimal.Parse(totprem.ToString());
            prem = prem * -1;

            DbRequestXmlCooker.AttachCookItem("TaskControlID", SqlDbType.Int, 0, taskControlID.ToString(), ref cookItems);
            DbRequestXmlCooker.AttachCookItem("TransactionAmount", SqlDbType.Money, 0, prem.ToString(), ref cookItems);

            DBRequest exec = new DBRequest();

            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                exec.Update("UpdateInceptionPartialPayments", xmlDoc);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not update Partial Payment.", ex);
            }
        }
        protected void btnCancellation_Click(object sender, EventArgs e)
        {
            RemoveSessionLookUp();
            Session.Add("FromUI", "CorporatePolicyQuote.aspx");
            Response.Redirect("CancellationPolicy.aspx", false);
        }
        protected void btnDelete_Click(object sender, EventArgs e)
        {
            TaskControl.CorporatePolicyQuote taskControl = (TaskControl.CorporatePolicyQuote)Session["TaskControl"];
            try
            {
                int i = taskControl.TaskControlID;
                TaskControl.CorporatePolicyQuote.DeleteCorporatePolicyByTaskControlID(i, taskControl.IsPolicy);
                taskControl = new TaskControl.CorporatePolicyQuote(false);
                taskControl.Mode = 4; //Clear

                Session["TaskControl"] = taskControl;
                Session.Clear();
                Response.Redirect("MainMenu.aspx");
            }
            catch (Exception exp)
            {
                this.litPopUp.Text = Utilities.MakeLiteralPopUpString("" + exp.Message);
                this.litPopUp.Visible = true;
            }
        }
        protected void btnPrintCertificate_Click(object sender, EventArgs e)
        {
            string js = "<script language=javascript> javascript:popwindow=window.open('PrintCertificate.aspx?','popwindow','toolbar=no,location=center,directories=no,status=no,menubar=no,scrollbars=yes,resizable=no,copyhistory=no,width=850,height=450');popwindow.focus(); </script>";
            Response.Write(js);
            DisableControls();
        }
        protected void CalculateCharge(object sender, EventArgs e)
        {
            if (Session["TaskControl"] != null)
            {
                TaskControl.CorporatePolicyQuote taskControl = (TaskControl.CorporatePolicyQuote)Session["TaskControl"];
                DataTable dtCharge = LookupTables.LookupTables.GetTable("Charge");
                int result = 0;

                for (int i = 0; i < dtCharge.Rows.Count; i++)
                {
                    result = DateTime.Compare(DateTime.Parse(txtEffDt.Text.ToString().Trim()),
                             DateTime.Parse(dtCharge.Rows[i]["effectiveDate"].ToString()));

                    if (result == 0 || result == 1)
                    {
                        double chargePercent = double.Parse(dtCharge.Rows[i]["chargePercent"].ToString());
                        int roundedUp = (int)Math.Ceiling(taskControl.TotalPremium * chargePercent);

                        TxtCharge.Text = roundedUp.ToString("###,###.#0").Trim();
                        TxtTotalPremium.Text = (taskControl.TotalPremium + roundedUp).ToString("###,###.#0").Trim();
                        taskControl.Charge = double.Parse(roundedUp.ToString("###,###.#0").Trim());
                        Label60.Visible = true;
                        Label60.Text = "Charge (" + chargePercent.ToString() + ")";
                        break;
                    }
                }
            }
        }
}
}